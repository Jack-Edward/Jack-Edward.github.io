<!DOCTYPE html><html lang="en"><script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"><script src="/live2d-widget/autoload.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="/tipuesearch/tipuesearch_content.js"></script><link rel="stylesheet" href="/tipuesearch/tipuesearch.css"><script src="/tipuesearch/tipuesearch_set.js"></script><script src="/tipuesearch/tipuesearch.min.js"></script><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>spring集成mybatis | MaoZH</title><script src="https://cdn.bootcss.com/valine/1.4.4/Valine.min.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/mermaid/8.11.0/mermaid.min.js"></script><script>mermaid.initialize({
  startOnLoad: true
  , theme: 'dark'
});</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="MaoZH" type="application/atom+xml">
</head><body><header><nav><a href="/">Home</a><a href="/archives/">Archives</a></nav></header><main><article><div id="post-bg"><div id="post-title"><h1>spring集成mybatis</h1><hr></div><div id="post-content"><h2 id="Spring-mybatis使用"><a href="#Spring-mybatis使用" class="headerlink" title="Spring-mybatis使用"></a>Spring-mybatis使用</h2><h3 id="一、项目实例"><a href="#一、项目实例" class="headerlink" title="一、项目实例"></a>一、项目实例</h3><h4 id="1-导入相关依赖"><a href="#1-导入相关依赖" class="headerlink" title="1.导入相关依赖"></a>1.导入相关依赖</h4><p>为了整合Spring框架与MyBatis框架，首先需要导入jar包：mybatis-spring-1.3.0</p>
<span id="more"></span>

<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-spring<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>3.4.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-jdbc<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.3.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/commons-dbcp/commons-dbcp --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>commons-dbcp<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-dbcp<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.4<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<h4 id="2-基本环境"><a href="#2-基本环境" class="headerlink" title="2.基本环境"></a>2.基本环境</h4><ul>
<li>实体类</li>
<li>接口</li>
<li>对应的增删查改mapper.xml文件</li>
<li>整合配置</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function">Configuration</span><br><span class="hljs-function"><span class="hljs-title">ComponentScan</span><span class="hljs-params">(basePackageClasses = &#123;Role.class&#125;)</span></span><br><span class="hljs-function"><span class="hljs-title">ImportResource</span><span class="hljs-params">(&#123;<span class="hljs-string">&quot;classpath:spring-mybatis.xml&quot;</span>&#125;)</span></span><br><span class="hljs-function"><span class="hljs-keyword">public</span> class ApplicationConfig </span>&#123;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="3-配置文件"><a href="#3-配置文件" class="headerlink" title="3.配置文件"></a>3.配置文件</h4><p>在单独使用MyBatis框架时，在配置MyBatis的全局配置文件SqlMapConfig.xml时，必须配置environments数据库环境配置，在该配置中需要配置数据库事务管理以及数据库连接池。但在Spring与MyBatis进行整合时，对数据源的配置将由MyBatis的全局配置中转移到Spring中配置。</p>
<p>database-config.properties属性文件用于存储数据库四要素属性值；spring-config.xml为Spring框架配置文件；SqlMapConfig.xml为MyBatis框架的核心配置文件</p>
<p><strong>database-config.properties</strong>(数据库四要素)</p>
<figure class="highlight properties"><table><tr><td class="code"><pre><code class="hljs properties"><span class="hljs-meta">jdbc.database.driver</span>=<span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br><span class="hljs-meta">jdbc.database.url</span>=<span class="hljs-string">jdbc:mysql://localhost:3306/test?useUnicode=true&amp;characterEncoding=UTF-8&amp;useJDBCCompliantTimezoneShift=true&amp;useLegacyDatetimeCode=false&amp;serverTimezone=UTC</span><br><span class="hljs-meta">jdbc.database.username</span>=<span class="hljs-string">root</span><br><span class="hljs-meta">jdbc.database.password</span>=<span class="hljs-string">root</span><br></code></pre></td></tr></table></figure>

<p>注意新版的mysql需要添加时区字符编码等参数，否则无法连接</p>
<p>第一步，在spring-mybatis.xml配置文件中配置数据源。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;UTF-8&#x27; ?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:p</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/p&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">	http://www.springframework.org/schema/beans/spring-beans-4.0.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">    http://www.springframework.org/schema/context</span></span><br><span class="hljs-string"><span class="hljs-tag">    http://www.springframework.org/schema/context/spring-context-4.0.xsd&quot;</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--加载属性文件--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:property-placeholder</span> <span class="hljs-attr">location</span>=<span class="hljs-string">&quot;database-config.properties&quot;</span> <span class="hljs-attr">ignore-resource-not-found</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>    <span class="hljs-comment">&lt;!--数据库连接池--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;driverClassName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.driver&#125;&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;url&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.url&#125;&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.username&#125;&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.password&#125;&quot;</span>/&gt;</span><br>        <span class="hljs-comment">&lt;!--连接池的最大数据库连接数--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;maxActive&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;255&quot;</span>/&gt;</span><br>        <span class="hljs-comment">&lt;!--最大等待连接的数量--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;minIdle&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;5&quot;</span>/&gt;</span><br>        <span class="hljs-comment">&lt;!--最大等待毫秒数--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;maxWait&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;10000&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>第二步，在Spring配置文件中配置SqlSessionFactoryBean，在MyBatis-Spring项目中提供了SqlSessionFactoryBean去支持SqlSessionFactory的配置。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;UTF-8&#x27; ?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:p</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/p&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">	http://www.springframework.org/schema/beans/spring-beans-4.0.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">    http://www.springframework.org/schema/context</span></span><br><span class="hljs-string"><span class="hljs-tag">    http://www.springframework.org/schema/context/spring-context-4.0.xsd&quot;</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--加载属性文件--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:property-placeholder</span> <span class="hljs-attr">location</span>=<span class="hljs-string">&quot;database-config.properties&quot;</span> <span class="hljs-attr">ignore-resource-not-found</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>    <span class="hljs-comment">&lt;!--数据库连接池--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;driverClassName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.driver&#125;&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;url&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.url&#125;&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.username&#125;&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.password&#125;&quot;</span>/&gt;</span><br>        <span class="hljs-comment">&lt;!--连接池的最大数据库连接数--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;maxActive&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;255&quot;</span>/&gt;</span><br>        <span class="hljs-comment">&lt;!--最大等待连接的数量--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;minIdle&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;5&quot;</span>/&gt;</span><br>        <span class="hljs-comment">&lt;!--最大等待毫秒数--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;maxWait&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;10000&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br>    <span class="hljs-comment">&lt;!--配置sqlSessionFactoryBean--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;sqlSessionFactory&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;dataSource&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;configLocation&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;classpath:SqlMapConfig.xml&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;mapperLocations&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;classpath*:cn/com/mao/dao/mapper/*Mapper.xml&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>第三步，配置MyBatis框架全局配置文件SqlMapConfig.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">configuration</span> <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">&quot;-//mybatis.org//DTD Config 3.0//EN&quot;</span> <span class="hljs-meta-string">&quot;http://mybatis.org/dtd/mybatis-3-config.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">settings</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- 这个配置使全局的映射器启用或禁用缓存 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;cacheEnabled&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>        <span class="hljs-comment">&lt;!-- 允许 JDBC 支持生成的键。需要适合[修改为：适当]的驱动。如果设置为true，则这个设置强制生成的键被使用，尽管一些驱动拒绝兼容但仍然有效（比如 Derby） --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;useGeneratedKeys&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>        <span class="hljs-comment">&lt;!-- 配置默认的执行器。SIMPLE 执行器没有什么特别之处。REUSE 执行器重用预处理语句。BATCH 执行器重用语句和批量更新  --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;defaultExecutorType&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;REUSE&quot;</span> /&gt;</span><br>        <span class="hljs-comment">&lt;!-- 全局启用或禁用延迟加载。当禁用时，所有关联对象都会即时加载 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;lazyLoadingEnabled&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>        <span class="hljs-comment">&lt;!-- 设置超时时间，它决定驱动等待一个数据库响应的时间  --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">setting</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;defaultStatementTimeout&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;25000&quot;</span>/&gt;</span> <br>    <span class="hljs-tag">&lt;/<span class="hljs-name">settings</span>&gt;</span><br>    <br>   <span class="hljs-comment">&lt;!-- 别名配置 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">typeAliases</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">typeAlias</span> <span class="hljs-attr">alias</span>=<span class="hljs-string">&quot;Role&quot;</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;cn.com.mao.pojo.Role&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">typeAliases</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 指定映射器路径 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">mappers</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--        &lt;package name=&quot;&quot;/&gt;--&gt;</span><br>        <span class="hljs-comment">&lt;!--        &lt;mapper resource=&quot;cn/com/mao/dao/mapper/RoleMapper.xml&quot; /&gt;--&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">mappers</span>&gt;</span><br>    <br><span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>这里代码是对实体以及对应的mapper接口单个进行配置；也可以使用包扫描方式扫描多个</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 别名配置 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">typeAliases</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">package</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;com.mao.pojo&quot;</span>/&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">typeAliases</span>&gt;</span><br><span class="hljs-comment">&lt;!-- 指定映射器路径 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">mappers</span>&gt;</span>            <br>        <span class="hljs-comment">&lt;!-- 批量加载     </span><br><span class="hljs-comment">            指定接口的包名称，自动扫描包下的所有mapper接口进行加载    </span><br><span class="hljs-comment">        --&gt;</span>    <br>        <span class="hljs-tag">&lt;<span class="hljs-name">package</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;com.mao.mapper&quot;</span>/&gt;</span>   <br><span class="hljs-tag">&lt;/<span class="hljs-name">mappers</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>默认的别名为对应首字母小写；取别名的作用是可以在mapper.xml当中写增删改查数据传入参数或输出结果时可以不用写全路径类名，可以使用定义的别名</p>
<p>第四步，在Spring配置文件中配置MapperFactoryBean。MyBatis的运行是通过它内部创建的动态代理对象运行的，所以Spring也没有办法为其生成实现类并对其进行管理。为解决这个问题，MyBatis-Spring项目提供了一个MapperFactoryBean类作为中介，我们可以通过在Spring的配置文件中配置MapperFactoryBean来实现我们想要的Mapper。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;UTF-8&#x27; ?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:p</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/p&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">	http://www.springframework.org/schema/beans/spring-beans-4.0.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">    http://www.springframework.org/schema/context</span></span><br><span class="hljs-string"><span class="hljs-tag">    http://www.springframework.org/schema/context/spring-context-4.0.xsd&quot;</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--加载属性文件--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:property-placeholder</span> <span class="hljs-attr">location</span>=<span class="hljs-string">&quot;database-config.properties&quot;</span> <span class="hljs-attr">ignore-resource-not-found</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 数据库连接池 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;driverClassName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.driver&#125;&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;url&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.url&#125;&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.username&#125;&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.password&#125;&quot;</span> /&gt;</span><br>        <span class="hljs-comment">&lt;!--连接池的最大数据库连接数 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;maxActive&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;255&quot;</span> /&gt;</span><br>        <span class="hljs-comment">&lt;!--最大等待连接中的数量 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;maxIdle&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;5&quot;</span> /&gt;</span><br>        <span class="hljs-comment">&lt;!--最大等待毫秒数 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;maxWait&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;10000&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 配置SqlSessionFactoryBean --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;sqlSessionFactory&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;dataSource&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;configLocation&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;classpath:SqlMapConfig.xml&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>	<span class="hljs-comment">&lt;!-- 配置MapperFactoryBean--&gt;</span><br>     <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;roleMapper&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.mybatis.spring.mapper.MapperFactoryBean&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;mapperInterface&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;cn.com.mao.dao.RoleMapper&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;sqlSessionFactory&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;sqlSessionFactory&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>SqlSessionFactoryBean存在4个属性可以配置：<br>datasource:数据源<br>configLocation:mybatis配置文件路径<br>typeAliasesPackage:实体别名扫描包<br>mapperLocations:扫描增删改查的mapper.xml文件包</p>
<p>MapperFactoryBean存在3个属性可以配置，分别是mapperInterface、sqlSessionFactory和sqlSessionTemplate。其中：mapperInterface是映射器的接口；如果同时配置sqlSessionTemplate和sqlSessionFactory，那么它就会启用sqlSessionTemplate，而sqlSessionFactory作废。</p>
<p><strong>当如果含有多个mapper接口时，这种方法就显然不合理了，因此可以换用MapperScannerConfigurer</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- 配置MapperScannerConfigurer--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;basePackage&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;cn.com.mao.dao&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;sqlSessionFactoryBeanName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;sqlSessionFactory&quot;</span>/&gt;</span><br>        <span class="hljs-comment">&lt;!--指定标注才扫描成为mapper--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;annotationClass&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;org.springframework.stereotype.Repository&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>通过上面的配置可知，MapperScannerConfigurer主要配置项如下：<br><strong>basePackage</strong>： 指定让Spring自动扫描什么包，它会逐层深入扫描，如果遇到多个包可以使用半角逗号分隔；<br><strong>sqlSessionFactoryBeanName</strong>： 指定在Spring中定义SqlSessionFactory的Bean的名称。如果sqlSessionTemplateBeanName被定义，那么它将失去作用；<br><strong>annotationClass</strong>： 表示如果类被这个注解标识时候，才进行扫描。对于开发而言，建议使用这个方式进行注册对应的Mapper。在Spring中往往使用注解 @Repository 表示数据访问层（DAO）。本篇文章中使用此方法，而不配置markerInterface；<br><strong>markerInterface</strong>： 指定实现了什么接口就人为它是Mapper，需要提供一个公共接口去标记。</p>
<p>第五步，为Mapper接口添加@Repository注解。 为mapper包中的RoleMapper添加注解@Repository，表示这个一个DAO层，同时为了告诉Spring在扫描Mapper接口文件时扫描该包。这样就可以扫描出对应的Mapper到Spring IoC容器中。</p>
<h5 id="配置SqlSessionTemplate组件（扩展）"><a href="#配置SqlSessionTemplate组件（扩展）" class="headerlink" title="配置SqlSessionTemplate组件（扩展）"></a>配置SqlSessionTemplate组件（<strong>扩展</strong>）</h5><p>SqlSessionTemplate并不是一个必须配置的组件，但是它也存在一定的价值。首先，它是线程安全的类，也就是确保每个线程使用的SqlSession是唯一且不互相冲突。其次，它提供了一系列的功能，比如增、删、查、改等常用功能，不过在此之前需要先配置它。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">&lt;?xml version=<span class="hljs-string">&#x27;1.0&#x27;</span> encoding=<span class="hljs-string">&#x27;UTF-8&#x27;</span> ?&gt;<br>&lt;beans xmlns=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span><br>       xmlns:xsi=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br>       xmlns:p=<span class="hljs-string">&quot;http://www.springframework.org/schema/p&quot;</span><br>       xmlns:context=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span><br>       xsi:schemaLocation=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span><br><span class="hljs-string">	http://www.springframework.org/schema/beans/spring-beans-4.0.xsd</span><br><span class="hljs-string">    http://www.springframework.org/schema/context</span><br><span class="hljs-string">    http://www.springframework.org/schema/context/spring-context-4.0.xsd&quot;</span>&gt;<br><br>    &lt;!--加载属性文件--&gt;<br>    &lt;context:property-placeholder location=<span class="hljs-string">&quot;database-config.properties&quot;</span> ignore-resource-not-found=<span class="hljs-string">&quot;true&quot;</span> /&gt;<br><br>    &lt;!-- 数据库连接池 --&gt;<br>    &lt;bean id=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span>&gt;<br>        &lt;property name=<span class="hljs-string">&quot;driverClassName&quot;</span> value=<span class="hljs-string">&quot;$&#123;jdbc.database.driver&#125;&quot;</span> /&gt;<br>        &lt;property name=<span class="hljs-string">&quot;url&quot;</span> value=<span class="hljs-string">&quot;$&#123;jdbc.database.url&#125;&quot;</span> /&gt;<br>        &lt;property name=<span class="hljs-string">&quot;username&quot;</span> value=<span class="hljs-string">&quot;$&#123;jdbc.database.username&#125;&quot;</span> /&gt;<br>        &lt;property name=<span class="hljs-string">&quot;password&quot;</span> value=<span class="hljs-string">&quot;$&#123;jdbc.database.password&#125;&quot;</span> /&gt;<br>        &lt;!--连接池的最大数据库连接数 --&gt;<br>        &lt;property name=<span class="hljs-string">&quot;maxActive&quot;</span> value=<span class="hljs-string">&quot;255&quot;</span> /&gt;<br>        &lt;!--最大等待连接中的数量 --&gt;<br>        &lt;property name=<span class="hljs-string">&quot;maxIdle&quot;</span> value=<span class="hljs-string">&quot;5&quot;</span> /&gt;<br>        &lt;!--最大等待毫秒数 --&gt;<br>        &lt;property name=<span class="hljs-string">&quot;maxWait&quot;</span> value=<span class="hljs-string">&quot;10000&quot;</span> /&gt;<br>    &lt;/bean&gt;<br><br>    &lt;!-- 配置SqlSessionFactoryBean --&gt;<br>    &lt;bean id=<span class="hljs-string">&quot;sqlSessionFactory&quot;</span> <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;<br>        &lt;property name=<span class="hljs-string">&quot;dataSource&quot;</span> ref=<span class="hljs-string">&quot;dataSource&quot;</span> /&gt;<br>        &lt;property name=<span class="hljs-string">&quot;configLocation&quot;</span> value=<span class="hljs-string">&quot;classpath:SqlMapConfig.xml&quot;</span> /&gt;<br>    &lt;/bean&gt;<br><br>    &lt;!-- 配置SqlSessionTemplate--&gt;<br>    &lt;bean id=<span class="hljs-string">&quot;sqlSessionTemplate&quot;</span> <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;org.mybatis.spring.SqlSessionTemplate&quot;</span>&gt;<br>        &lt;constructor-arg ref=<span class="hljs-string">&quot;sqlSessionFactory&quot;</span> /&gt;<br>        &lt;constructor-arg value=<span class="hljs-string">&quot;BATCH&quot;</span>/&gt;<br>    &lt;/bean&gt;<br><br>	&lt;!-- 配置MapperScannerConfigurer--&gt;<br>    &lt;bean <span class="hljs-class"><span class="hljs-keyword">class</span></span>=<span class="hljs-string">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span>&gt;<br>        &lt;property name=<span class="hljs-string">&quot;basePackage&quot;</span> value=<span class="hljs-string">&quot;com.ccff.spring.mapper&quot;</span> /&gt;<br>        &lt;property name=<span class="hljs-string">&quot;sqlSessionFactoryBeanName&quot;</span> value=<span class="hljs-string">&quot;sqlSessionFactory&quot;</span> /&gt;<br>        &lt;!-- 使用sqlSessionTemplateBeanName将覆盖sqlSessionFactoryBeanName的配置 --&gt;<br>        &lt;!-- &lt;property name=<span class="hljs-string">&quot;sqlSessionTemplateBeanName&quot;</span> value=<span class="hljs-string">&quot;sqlSessionFactory&quot;</span>/&gt; --&gt;<br>        &lt;!-- 指定标注才扫描成为Mapper --&gt;<br>        &lt;property name=<span class="hljs-string">&quot;annotationClass&quot;</span> value=<span class="hljs-string">&quot;org.springframework.stereotype.Repository&quot;</span> /&gt;<br>    &lt;/bean&gt;<br>&lt;/beans&gt;<br></code></pre></td></tr></table></figure>

<p>当运行一个SqlSessionTemplate时，它就会重新获取一个新的SqlSession，也就是说每一个SqlSessionTemplate运行的时候会产生新的SqlSession，所以每一个方法都是独立的SqlSession，这意味着它是线程安全的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">testSqlSessioTemplate</span><span class="hljs-params">()</span> </span>&#123;<br>    SqlSessionTemplate template = context.getBean(SqlSessionTemplate.class);<br>    <span class="hljs-comment">//添加用户</span><br>    String path = <span class="hljs-string">&quot;cn.com.mao.dao.RoleMapper&quot;</span>;<br>    role.setRoleName(<span class="hljs-string">&quot;sqlSessionTemplate-name&quot;</span>);<br>    role.setRoleNote(<span class="hljs-string">&quot;sqlSessionTemplate-note&quot;</span>);<br>    template.insert(<span class="hljs-string">&quot;cn.com.mao.dao.RoleMapper.insertRole()&quot;</span>, role);<br>    <span class="hljs-comment">//查询用户</span><br>    Long id = role.getId();<br>    role = template.selectOne(<span class="hljs-string">&quot;cn.com.mao.dao.RoleMapper.getRoleById&quot;</span>, id);<br>    System.out.println(role);<br>    <span class="hljs-comment">//更新用户</span><br>    role.setRoleName(<span class="hljs-string">&quot;update-role-name-forSqlSessionTemplate&quot;</span>);<br>    template.update(<span class="hljs-string">&quot;cn.com.mao.dao.RoleMapper.updateRole&quot;</span>, role);<br>    <span class="hljs-comment">//删除用户</span><br>    template.delete(<span class="hljs-string">&quot;cn.com.mao.dao.RoleMapper.deleteRole&quot;</span>, id);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>值得注意的是SqlSessionTemplate允许配置执行器的类型，当同时配置SqlSessionFactory和SqlSessionTemplate的时候，SqlSessionTemplate的优先级大于SqlSessionFactory。</p>
<p><img src="/2021/11/21/spring%E9%9B%86%E6%88%90mybatis/image-20211120180019833.png" alt="image-20211120180019833"></p>
<h2 id="Spring与MyBatis事务"><a href="#Spring与MyBatis事务" class="headerlink" title="Spring与MyBatis事务"></a>Spring与MyBatis事务</h2><h3 id="一、数据库隔离级别与传播行为"><a href="#一、数据库隔离级别与传播行为" class="headerlink" title="一、数据库隔离级别与传播行为"></a>一、数据库隔离级别与传播行为</h3><h4 id="1-数据库隔离级别"><a href="#1-数据库隔离级别" class="headerlink" title="1.数据库隔离级别"></a>1.数据库隔离级别</h4><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yblackd/p/12117084.html">https://www.cnblogs.com/yblackd/p/12117084.html</a></p>
<p>并行事务的四大问题：第一，更新丢失：和别的事务读到相同的东西，各自写，自己的写被覆盖了。（谁写的快谁的更新就丢失了）。第二，脏读：读到别的事务未提交的数据。（万一回滚，数据就是脏的无效的了）。第三，不可重复读：两次读之间有别的事务修改，读到的数据不一致。第四，幻读：两次读之间有别的事务增删，虽然读到的数据一致，但是整个集合的数量或者查询的集合里的数量发生了改变。</p>
<table>
<thead>
<tr>
<th>隔离级别</th>
<th>脏读</th>
<th>不可重复读</th>
<th>幻读</th>
</tr>
</thead>
<tbody><tr>
<td>读未提交</td>
<td>可能</td>
<td>可能</td>
<td>可能</td>
</tr>
<tr>
<td>读已提交</td>
<td>不可能</td>
<td>可能</td>
<td>可能</td>
</tr>
<tr>
<td>可重复读</td>
<td>不可能</td>
<td>不可能</td>
<td>可能</td>
</tr>
<tr>
<td>可序列化</td>
<td>不可能</td>
<td>不可能</td>
<td>不可能</td>
</tr>
</tbody></table>
<p>在实际工作中，注解@Transactional隔离级别的默认值为Isolation.DEFAULT，其含义是默认的，随数据库默认值的变化而变化。因为对不同的数据库而言，隔离级别的支持是不一样的。在MySQL中可支持4种隔离级别，而默认的是可重复读的隔离级别。而在Oracle中只支持读已提交和可序列化两种隔离级别，默认值是读已提交。</p>
<h4 id="2-Spring的7种传播行为"><a href="#2-Spring的7种传播行为" class="headerlink" title="2.Spring的7种传播行为"></a>2.Spring的7种传播行为</h4><p>在Spring中传播行为的类型，是通过一个枚举类型去定义的，这个枚举类是org.springframework.transaction.annotation.Propagation，它定义了如下表所示的7种传播类型。</p>
<table>
<thead>
<tr>
<th align="center"><strong>传播行为</strong></th>
<th align="center"><strong>含义</strong></th>
<th align="center"><strong>备注</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center">REQUIRED</td>
<td align="center">当方法调用时，如果不存在当前事务，那么就创建事务；如果之前的方法已经存在事务了，那么就沿用之前的事务</td>
<td align="center">这是Spring默认的传播行为</td>
</tr>
<tr>
<td align="center">SUPPORTS</td>
<td align="center">当方法调用时，如果不存在当前事务，那么不启用事务；如果存在当前事务，那么就沿用当前事务</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">MANDATORY</td>
<td align="center">方法必须在事务内运行</td>
<td align="center">如果不存在当前事务，那么就抛出异常</td>
</tr>
<tr>
<td align="center">REQUIRES_NEW</td>
<td align="center">无论是否存在当前事务，方法都会在新的事务中运行</td>
<td align="center">事务管理器会打开新的事务运行该方法</td>
</tr>
<tr>
<td align="center">NOT_SUPPORTED</td>
<td align="center">不支持事务，如果不存在当前事务也不会创建事务；如果存在当前事务，则挂起它，纸质该方法结束后才恢复当前事务</td>
<td align="center">适用于那些不需要事务的SQL</td>
</tr>
<tr>
<td align="center">NEVER</td>
<td align="center">不支持事务，只有在没有事务的环境中才能运行它</td>
<td align="center">如果存在当前事务，那么就抛出异常</td>
</tr>
<tr>
<td align="center">NESTED</td>
<td align="center">嵌套事务，也就是调用方法如果抛出异常只回滚自己内部执行的SQL，而不回滚主方法的SQL</td>
<td align="center">它的实现存在两种情况，如果当前数据库支持保存点（savepoint），那么它就会在当前事务上使用保存点技术；如果发生异常则将方法内执行的SQL回滚到保存点上，而不是全部回滚，否则就等同于REQUIRES_NEW创建新的事务运行方法代码</td>
</tr>
</tbody></table>
<h4 id="3-声明式事务"><a href="#3-声明式事务" class="headerlink" title="3.声明式事务"></a>3.声明式事务</h4><p>在Spring中可以使用编程式事务与声明式事务，编程式事务会产生冗余。声明式事务又可以分为XML配置和注解事务，但XML方式也已经不常用了，目前主流方法是注解@Transactional</p>
<p>声明式事务是一种约定型的事务，在大部分情况下，当使用数据库事务时，大部分的场景是在代码中发生了异常时，需要回滚事务，而不发生异常时则是提交事务，从而保证数据库数据的一致性。从这点出发，Spring给了一个约定，如果使用的是声明式事务，那么当你的业务方法不发生异常（或者发生异常，但该异常也被配置信息允许提交事务）时，Spring就会让事务管理器提交事务，而发生异常（并且该异常不被你的配置信息所允许提交事务）时，则让事务管理器回滚事务。</p>
<p><strong>注解@Transactional配置项</strong></p>
<table>
<thead>
<tr>
<th align="center"><strong>配置项</strong></th>
<th align="center"><strong>含义</strong></th>
<th align="center"><strong>备注</strong></th>
</tr>
</thead>
<tbody><tr>
<td align="center">value</td>
<td align="center">定义事务管理器</td>
<td align="center">它是Spring IoC容器里的一个Bean id，这个Bean需要实现接口PlatformTransactionManager</td>
</tr>
<tr>
<td align="center">transactionManager</td>
<td align="center">同上</td>
<td align="center">同上</td>
</tr>
<tr>
<td align="center">isolation</td>
<td align="center">隔离级别</td>
<td align="center">这是一个数据库在多个事务同时存在时的概念，默认值取数据库默认的隔离级别</td>
</tr>
<tr>
<td align="center">propagation</td>
<td align="center">传播行为</td>
<td align="center">传播行为是方法之间调用的问题，默认值为Propagation.REQUIRED</td>
</tr>
<tr>
<td align="center">timeout</td>
<td align="center">超时时间</td>
<td align="center">单位为秒，当超时时，会引发异常，默认会导致事务回滚</td>
</tr>
<tr>
<td align="center">readOnly</td>
<td align="center">是否开启只读事务</td>
<td align="center">默认值为false</td>
</tr>
<tr>
<td align="center">rollbackFor</td>
<td align="center">回滚事务的异常类定义</td>
<td align="center">就是只有当方法产生所定义异常时，才回滚事务，否则就提交事务</td>
</tr>
<tr>
<td align="center">rollbackForClassName</td>
<td align="center">回滚事务的异常类名定义</td>
<td align="center">同rollbackFor，只是使用类名称定义</td>
</tr>
<tr>
<td align="center">noRollbackFor</td>
<td align="center">当产生哪些异常不回滚事务</td>
<td align="center">当产生所定义的异常时，Spring会继续提交事务</td>
</tr>
<tr>
<td align="center">noRollbackForClassName</td>
<td align="center">同noRollbackFor</td>
<td align="center">同noRollbackFor，只是使用类的名称定义</td>
</tr>
</tbody></table>
<p>两种方式开启@Transactional事务支持</p>
<p>第一种是在Spring的配置XML文件spring-config.xml中通过如下配置开启</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;UTF-8&#x27; ?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="hljs-attr">xmlns:p</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/p&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:aop</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/aop&quot;</span> <span class="hljs-attr">xmlns:tx</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/tx&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans</span></span><br><span class="hljs-string"><span class="hljs-tag">	   http://www.springframework.org/schema/beans/spring-beans-4.0.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">       http://www.springframework.org/schema/aop</span></span><br><span class="hljs-string"><span class="hljs-tag">       http://www.springframework.org/schema/aop/spring-aop-4.0.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">       http://www.springframework.org/schema/tx</span></span><br><span class="hljs-string"><span class="hljs-tag">       http://www.springframework.org/schema/tx/spring-tx-4.0.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">       http://www.springframework.org/schema/context</span></span><br><span class="hljs-string"><span class="hljs-tag">       http://www.springframework.org/schema/context/spring-context-4.0.xsd&quot;</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--加载属性文件--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context:property-placeholder</span> <span class="hljs-attr">location</span>=<span class="hljs-string">&quot;database-config.properties&quot;</span> <span class="hljs-attr">ignore-resource-not-found</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 数据库连接池 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.apache.commons.dbcp.BasicDataSource&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;driverClassName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.driver&#125;&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;url&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.url&#125;&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;username&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.username&#125;&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;password&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.password&#125;&quot;</span> /&gt;</span><br>        <span class="hljs-comment">&lt;!--连接池的最大数据库连接数 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;maxActive&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;255&quot;</span> /&gt;</span><br>        <span class="hljs-comment">&lt;!--最大等待连接中的数量 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;maxIdle&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;5&quot;</span> /&gt;</span><br>        <span class="hljs-comment">&lt;!--最大等待毫秒数 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;maxWait&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;10000&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;sqlSessionFactory&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.mybatis.spring.SqlSessionFactoryBean&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;dataSource&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;configLocation&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;classpath:sqlMapConfig.xml&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.mybatis.spring.mapper.MapperScannerConfigurer&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;basePackage&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;cn.com.dao&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;sqlSessionFactoryBeanName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;sqlSessionFactory&quot;</span> /&gt;</span><br>        <span class="hljs-comment">&lt;!-- 使用sqlSessionTemplateBeanName将覆盖sqlSessionFactoryBeanName的配置 --&gt;</span><br>        <span class="hljs-comment">&lt;!-- &lt;property name=&quot;sqlSessionTemplateBeanName&quot; value=&quot;sqlSessionFactory&quot;/&gt; --&gt;</span><br>        <span class="hljs-comment">&lt;!-- 指定标注才扫描成为Mapper --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;annotationClass&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;org.springframework.stereotype.Repository&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!--定义事务管理器--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;transactionManager&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dataSource&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;dataSource&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-comment">&lt;!-- 使用注解定义事务 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">tx:annotation-driven</span> <span class="hljs-attr">transaction-manager</span>=<span class="hljs-string">&quot;transactionManager&quot;</span> /&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>第二种方式是在Java Config配置类中通过注解@EnableTransactionManagement，使用事务驱动管理器</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java">Configuration<br><span class="hljs-meta">@ComponentScan(basePackageClasses = &#123;Role.class&#125;)</span><br><span class="hljs-meta">@ImportResource(&#123;&quot;spring-config.xml&quot;&#125;)</span><br><span class="hljs-meta">@EnableTransactionManagement</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JavaConfig</span></span>&#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>声明式事务约定流程</strong></p>
<p>注解@Transactional可以使用在方法或者类上面，在Spring IoC容器初始化时，Spring会读入这个注解的事务信息，并且保存到一个事务定义类里面（TransactionDefinition接口的子类），以备将来使用。当运行时会让Spring拦截注解标注的某一个方法或者类的所有方法。</p>
<p>首先Spring通过事务管理器（PlatformTransactionManager的子类）创建事务，榆次同时会把事务定义中的隔离级别、超时时间等属性根据配置内容往事务上设置。而根据传播行为配置采取一种特定的策略，这是Spring根据配置完成的内容，作为你开发者的我们只需要配置，无须编码。</p>
<p>然后启动开发者提供的业务代码，此时Spring会通过反射的方式调度开发者的业务代码，但是反射的结果可能是正常返回或者产生异常返回，那么它给定的约定是只要发生异常，并且符合事务定义类回滚条件的，Spring就会将数据库事务回滚，否则将数据库事务提交，这也是Spring自己完成的。</p>
<h4 id="4-spring-mybatis组合使用事务"><a href="#4-spring-mybatis组合使用事务" class="headerlink" title="4.spring+mybatis组合使用事务"></a>4.spring+mybatis组合使用事务</h4><p>其他的配置基本不变，spring-config.xml把使用注解定义事务去掉。</p>
<p>在service层使用@Tansactional()注解，根据具体的要求进行相应的配置。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RoleServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RoleService</span> </span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RoleMapper roleMapper = <span class="hljs-keyword">null</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW,isolation = Isolation.READ_COMMITTED)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">insertRole</span><span class="hljs-params">(Role role)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> roleMapper.insertRole(role);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>由于insertRole方法采用了Propagation.REQUIER_NEW的传播行为，因此每当insertRoleList方法调度了insertRole方法时，就会产生一个新的事务。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RoleListServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RoleListService</span> </span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RoleService roleService = <span class="hljs-keyword">null</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED,isolation = Isolation.READ_COMMITTED)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">insertListRole</span><span class="hljs-params">(List&lt;Role&gt; roleList)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (Role role : roleList)&#123;<br>            <span class="hljs-keyword">try</span>&#123;<br>                count += roleService.insertRole(role);<br>            &#125;<span class="hljs-keyword">catch</span> (Exception ex)&#123;<br>                ex.printStace();<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> count;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后在配置类当中加入</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-meta">@ComponentScan(basePackageClasses = &#123;Role.class,RoleService.class&#125;)</span><br><span class="hljs-meta">@ImportResource(&#123;&quot;spring-config.xml&quot;&#125;)</span><br><span class="hljs-meta">@EnableTransactionManagement</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">JavaConfig</span></span>&#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>测试</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test1</span><span class="hljs-params">()</span></span>&#123;<br>        ApplicationContext context = <span class="hljs-keyword">new</span> AnnotationConfigApplicationContext(JavaConfig.class);<br>        RoleListService roleListService = context.getBean(RoleListService.class);<br>        List&lt;Role&gt; roleList = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">1</span>; i &lt;= <span class="hljs-number">3</span>; i++) &#123;<br>            Role role = context.getBean(Role.class);<br>            role.setId(Long.parseLong(i+<span class="hljs-string">&quot;&quot;</span>));<br>            role.setRoleName(<span class="hljs-string">&quot;role-name-&quot;</span>+i);<br>            role.setRoleNote(<span class="hljs-string">&quot;role-note-&quot;</span>+i);<br>            roleList.add(role);<br>        &#125;<br>        <span class="hljs-keyword">int</span> count = roleListService.insertListRole(roleList);<br>        System.out.println(count);<br>    &#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>由于insertRoleList会调用insertRole，而insertRole标注了REQUIRE_NEW，所以每次调用会产生新的事务。</li>
</ul>
<h4 id="5-注意"><a href="#5-注意" class="headerlink" title="5.注意"></a>5.注意</h4><p><strong>注解@Transactional的自调用失效问题</strong></p>
<p>注解@Transactional的底层实现是Spring AOP技术，而Spring AOP技术使用的是动态代理。这就意味着对于静态（static）方法和非public方法，注解@Transactional是失效的。还有一个更为隐秘的情况，而且在使用过程中极其容易犯错误的——自调用。所谓自调用就是一个类的一个方法去调用自身另一个方法的过程。<br>如果存在一个接口：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">RoleService2</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">insertRole</span><span class="hljs-params">(Role role)</span></span>;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">insertListRole</span><span class="hljs-params">(List&lt;Role&gt; roleList)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其实现方式为：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RoleService2Impl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RoleService2</span> </span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RoleMapper roleMapper = <span class="hljs-keyword">null</span>;<br><br>    Logger logger = Logger.getLogger(RoleService2Impl.class);<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW,isolation = Isolation.READ_COMMITTED)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">insertRole</span><span class="hljs-params">(Role role)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> roleMapper.insertRole(role);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED,isolation = Isolation.READ_COMMITTED)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">insertListRole</span><span class="hljs-params">(List&lt;Role&gt; roleList)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">for</span> (Role role : roleList)&#123;<br>            <span class="hljs-keyword">try</span>&#123;<br>            	<span class="hljs-comment">//调用自身类的方法，产生自调用问题</span><br>                insertRole(role);<br>                count++;<br>            &#125;<span class="hljs-keyword">catch</span> (Exception ex)&#123;<br>                logger.info(ex);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> count;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>也就是批量插入的时候调用了自身类的方法，测试时可以观察日志，此时角色插入每次都使用了同一个事务，也就是说，在insertRole方法上标注的@Transactional失效了。</li>
<li>解决方法：AOP的实现原理是动态代理，而在RoleService2Impl中使用的是自己调用自己的过程。换句话说，并不存在代理对象的调用，这样就不会产生AOP去为我们设置@Transactional配置的参数，这样就出现了自调用注解失效的问题。因此我们也可以直接从容器中获取RoleService的代理对象，从IoC容器中获取RoleService对象。</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RoleService2Impl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">RoleService2</span> </span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RoleMapper roleMapper = <span class="hljs-keyword">null</span>;<br><br>    Logger logger = Logger.getLogger(RoleService2Impl.class);<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRES_NEW,isolation = Isolation.READ_COMMITTED)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">insertRole</span><span class="hljs-params">(Role role)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> roleMapper.insertRole(role);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED,isolation = Isolation.READ_COMMITTED)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">insertListRole</span><span class="hljs-params">(List&lt;Role&gt; roleList)</span> </span>&#123;<br>        <span class="hljs-keyword">int</span> count = <span class="hljs-number">0</span>;<br>        ApplicationContext context = <span class="hljs-keyword">new</span> AnnotationConfigApplicationContext(JavaConfig.class);<br>        RoleService2 roleService2 = context.getBean(RoleService2.class);<br>        <span class="hljs-keyword">for</span> (Role role : roleList)&#123;<br>            <span class="hljs-keyword">try</span>&#123;<br>                count += roleService2.insertRole(role);<br>            &#125;<span class="hljs-keyword">catch</span> (Exception ex)&#123;<br>                logger.info(ex);<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> count;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><strong>过长时间占用事务</strong></p>
<p>使用了数据库事务之后，要及时释放数据库事务。如果一个事务在执行时其中有一部分逻辑花费了很长时间，导致Spring一直没有释放数据库事务资源，一些请求就会出现一直在等待数据库事务资源分配。此时解决方法就是将这些比较花费时间的操作放入controller当中，而不是放到事务中。</p>
<p><strong>错误捕获异常</strong></p>
<p>模拟一段购买商品的代码，其中ProductService是产品服务类，而TransactionService是记录交易信息，需求显然就是产品减库存和保存交易在同一个事务里面，要么同时成功，要么同时失败，并且假设减库存和保存交易的传播行为都为REQUIRED，具体代码如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> ProductServcie productServcie;<br><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> TransactionService transactionService;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED,isolation = Isolation.READ_COMMITTED)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">doTransaction</span><span class="hljs-params">(TransactionBean trans)</span></span>&#123;<br>	<span class="hljs-keyword">int</span> result = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">try</span>&#123;<br>		<span class="hljs-comment">//减少库存</span><br>		<span class="hljs-keyword">int</span> result = productServcie.decreaseStock(trans.getProductId, trans.getQuantity());<br>		<span class="hljs-comment">//如果减少库存成功则保存记录</span><br>		<span class="hljs-keyword">if</span>(result &gt; <span class="hljs-number">0</span>)&#123;<br>			transactionService.save(trans);<br>		&#125;<br>	&#125;<span class="hljs-keyword">catch</span>(Exception ex)&#123;<br>		<span class="hljs-comment">//自行处理异常代码</span><br>		<span class="hljs-comment">//记录异常日志</span><br>		log.info(ex);<br>	&#125;<br>	<span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>开发者在两个操作的方法里面加入了自己的try/catch语句，就可能发生这样的结果：当减少库存成功了，但是保存交易信息时失败而发生了异常，此时由于开发者加入了try/catch语句，所以Spring在数据库事务所约定的流程中再也得不到任何异常信息了，此时Spring就会提交事务，这样就出现了库存减少，而交易记录却没有保存的糟糕情况。</p>
<p>改进：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> ProductServcie productServcie;<br><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> TransactionService transactionService;<br><br><span class="hljs-meta">@Override</span><br><span class="hljs-meta">@Transactional(propagation = Propagation.REQUIRED,isolation = Isolation.READ_COMMITTED)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">int</span> <span class="hljs-title">doTransaction</span><span class="hljs-params">(TransactionBean trans)</span></span>&#123;<br>	<span class="hljs-keyword">int</span> result = <span class="hljs-number">0</span>;<br>	<span class="hljs-keyword">try</span>&#123;<br>		<span class="hljs-comment">//减少库存</span><br>		<span class="hljs-keyword">int</span> result = productServcie.decreaseStock(trans.getProductId, trans.getQuantity());<br>		<span class="hljs-comment">//如果减少库存成功则保存记录</span><br>		<span class="hljs-keyword">if</span>(result &gt; <span class="hljs-number">0</span>)&#123;<br>			transactionService.save(trans);<br>		&#125;<br>	&#125;<span class="hljs-keyword">catch</span>(Exception ex)&#123;<br>		<span class="hljs-comment">//自行处理异常代码</span><br>		<span class="hljs-comment">//记录异常日志</span><br>		log.info(ex);<br>		<span class="hljs-comment">//自行抛出异常，让Spring事务管理流程获取异常，进行事务管理</span><br>		<span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> RuntimeException(ex);<br>	&#125;<br>	<span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>当执行方法出现异常时，让其自身自行抛出一个运行异常，这样在spring事务当中就会捕获抛出的异常进行事务回滚，保证了产品减库存和交易记录保存的一致性。<br><a target="_blank" rel="noopener" href="https://www.jianshu.com/p/b519e9ef605f">https://www.jianshu.com/p/b519e9ef605f</a><br><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_35849955/article/details/85993036">https://blog.csdn.net/qq_35849955/article/details/85993036</a></li>
</ul>
<h2 id="mybatisGenerator使用"><a href="#mybatisGenerator使用" class="headerlink" title="mybatisGenerator使用"></a>mybatisGenerator使用</h2><h3 id="1-导入maven构建包配置"><a href="#1-导入maven构建包配置" class="headerlink" title="1.导入maven构建包配置"></a>1.导入maven构建包配置</h3><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">build</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">resources</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/resources<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.properties<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.xml<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">filtering</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">filtering</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">directory</span>&gt;</span>src/main/java<span class="hljs-tag">&lt;/<span class="hljs-name">directory</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">includes</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.properties<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">include</span>&gt;</span>**/*.xml<span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">includes</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">filtering</span>&gt;</span>false<span class="hljs-tag">&lt;/<span class="hljs-name">filtering</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">resources</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">plugins</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">plugin</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.mybatis.generator<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>mybatis-generator-maven-plugin<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>1.3.5<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>                <span class="hljs-tag">&lt;<span class="hljs-name">configuration</span>&gt;</span><br>                    <span class="hljs-comment">&lt;!-- 在控制台打印执行日志 --&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">verbose</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">verbose</span>&gt;</span><br>                    <span class="hljs-comment">&lt;!-- 重复生成时会覆盖之前的文件--&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">overwrite</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">overwrite</span>&gt;</span><br>                    <span class="hljs-tag">&lt;<span class="hljs-name">configurationFile</span>&gt;</span>src/main/resources/generatorConfig.xml<span class="hljs-tag">&lt;/<span class="hljs-name">configurationFile</span>&gt;</span><br>                <span class="hljs-tag">&lt;/<span class="hljs-name">configuration</span>&gt;</span><br>                <span class="hljs-comment">&lt;!-- 数据库连接选择8.0以上的，因为用的mysql8.0--&gt;</span><br><span class="hljs-comment">&lt;!--                &lt;dependencies&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--                    &lt;dependency&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--                        &lt;groupId&gt;mysql&lt;/groupId&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--                        &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--                        &lt;version&gt;8.0.16&lt;/version&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--                    &lt;/dependency&gt;--&gt;</span><br><span class="hljs-comment">&lt;!--                &lt;/dependencies&gt;--&gt;</span><br>            <span class="hljs-tag">&lt;/<span class="hljs-name">plugin</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">plugins</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">build</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><img src="/2021/11/21/spring%E9%9B%86%E6%88%90mybatis/image-20211120164931634.png" alt="image-20211120164931634"></p>
<p>然后就能够看到管理工具</p>
<h3 id="2-resources下创建generatorConfig-xml"><a href="#2-resources下创建generatorConfig-xml" class="headerlink" title="2.resources下创建generatorConfig.xml"></a>2.resources下创建generatorConfig.xml</h3><figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-meta-keyword">generatorConfiguration</span></span><br><span class="hljs-meta">        <span class="hljs-meta-keyword">PUBLIC</span> <span class="hljs-meta-string">&quot;-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN&quot;</span></span><br><span class="hljs-meta">        <span class="hljs-meta-string">&quot;http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">generatorConfiguration</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">properties</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;database-config.properties&quot;</span>/&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">classPathEntry</span></span><br><span class="hljs-tag">            <span class="hljs-attr">location</span>=<span class="hljs-string">&quot;D:\\maven_lib\\repository\\mysql\\mysql-connector-java\\8.0.26\\mysql-connector-java-8.0.26.jar&quot;</span> /&gt;</span><br>    <span class="hljs-comment">&lt;!-- context 是逆向工程的主要配置信息 --&gt;</span><br>    <span class="hljs-comment">&lt;!-- id：起个名字 --&gt;</span><br>    <span class="hljs-comment">&lt;!-- targetRuntime：设置生成的文件适用于那个 mybatis 版本 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">context</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;default&quot;</span> <span class="hljs-attr">targetRuntime</span>=<span class="hljs-string">&quot;MyBatis3&quot;</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--optional,指在创建class时，对注释进行控制--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">commentGenerator</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;suppressDate&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>            <span class="hljs-comment">&lt;!-- 是否去除自动生成的注释 true：是 ： false:否 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;suppressAllComments&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">commentGenerator</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--jdbc的数据库连接 wg_insert 为数据库名字--&gt;</span><br><span class="hljs-comment">&lt;!--        &lt;jdbcConnection driverClass=&quot;com.mysql.cj.jdbc.Driver&quot;--&gt;</span><br><span class="hljs-comment">&lt;!--                        connectionURL=&quot;jdbc:mysql://localhost:3306/wg_insert?useUnicode=true&amp;amp;characeterEncoding=utf-8&amp;amp;serverTimezone=UTC&quot;--&gt;</span><br><span class="hljs-comment">&lt;!--                        userId=&quot;root&quot;--&gt;</span><br><span class="hljs-comment">&lt;!--                        password=&quot;123456&quot;&gt;&lt;/jdbcConnection&gt;--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">jdbcConnection</span></span><br><span class="hljs-tag">            <span class="hljs-attr">driverClass</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.driver&#125;&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">connectionURL</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.url&#125;&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">userId</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.username&#125;&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.password&#125;&quot;</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--因为获取表结构是从mysql的schema中获取的，并不是直接或取得table结构。如果多个库中存在多个重名的表那就回出现错乱。可增加配置项解决该问题--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;nullCatalogMeansCurrent&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">jdbcConnection</span>&gt;</span><br>        <span class="hljs-comment">&lt;!--非必须，类型处理器，在数据库类型和java类型之间的转换控制--&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">javaTypeResolver</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 默认情况下数据库中的 decimal，bigInt 在 Java 对应是 sql 下的 BigDecimal 类 --&gt;</span><br>            <span class="hljs-comment">&lt;!-- 不是 double 和 long 类型 --&gt;</span><br>            <span class="hljs-comment">&lt;!-- 使用常用的基本类型代替 sql 包下的引用类型 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;forceBigDecimals&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">javaTypeResolver</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- targetPackage：生成的实体类所在的包 --&gt;</span><br>        <span class="hljs-comment">&lt;!-- targetProject：生成的实体类所在的硬盘位置 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">javaModelGenerator</span> <span class="hljs-attr">targetPackage</span>=<span class="hljs-string">&quot;cn.com.mao.pojo&quot;</span></span><br><span class="hljs-tag">                            <span class="hljs-attr">targetProject</span>=<span class="hljs-string">&quot;src/main/java&quot;</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 是否允许子包 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;enableSubPackages&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br>            <span class="hljs-comment">&lt;!-- 是否对modal添加构造函数 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;constructorBased&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>            <span class="hljs-comment">&lt;!-- 是否清理从数据库中查询出的字符串左右两边的空白字符 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;trimStrings&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>            <span class="hljs-comment">&lt;!-- 建立modal对象是否不可改变 即生成的modal对象不会有setter方法，只有构造方法 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;immutable&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">javaModelGenerator</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- targetPackage 和 targetProject：生成的 mapper xml文件的包和位置 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">sqlMapGenerator</span> <span class="hljs-attr">targetPackage</span>=<span class="hljs-string">&quot;cn.com.mao.dao.mapper&quot;</span></span><br><span class="hljs-tag">                         <span class="hljs-attr">targetProject</span>=<span class="hljs-string">&quot;src/main/java&quot;</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 针对数据库的一个配置，是否把 schema 作为字包名 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;enableSubPackages&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">sqlMapGenerator</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- targetPackage 和 targetProject：生成的 interface 文件的包和位置 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">javaClientGenerator</span> <span class="hljs-attr">type</span>=<span class="hljs-string">&quot;XMLMAPPER&quot;</span></span><br><span class="hljs-tag">                             <span class="hljs-attr">targetPackage</span>=<span class="hljs-string">&quot;cn.com.mao.dao&quot;</span> <span class="hljs-attr">targetProject</span>=<span class="hljs-string">&quot;src/main/java&quot;</span>&gt;</span><br>            <span class="hljs-comment">&lt;!-- 针对 oracle 数据库的一个配置，是否把 schema 作为字包名 --&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;enableSubPackages&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;false&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">javaClientGenerator</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- tableName是数据库中的表名，domainObjectName是生成的JAVA模型名，后面的参数不用改，要生成更多的表就在下面继续加table标签 --&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">tableName</span>=<span class="hljs-string">&quot;user&quot;</span> <span class="hljs-attr">domainObjectName</span>=<span class="hljs-string">&quot;User&quot;</span></span><br><span class="hljs-tag">               <span class="hljs-attr">enableCountByExample</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">enableUpdateByExample</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">               <span class="hljs-attr">enableDeleteByExample</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">enableSelectByExample</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">               <span class="hljs-attr">selectByExampleQueryId</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br>        <span class="hljs-comment">&lt;!-- tableName是数据库中的表名，domainObjectName是生成的JAVA模型名，后面的参数不用改，要生成更多的表就在下面继续加table标签 --&gt;</span><br><span class="hljs-comment">&lt;!--        &lt;table tableName=&quot;post&quot; domainObjectName=&quot;Post&quot;--&gt;</span><br><span class="hljs-comment">&lt;!--               enableCountByExample=&quot;false&quot; enableUpdateByExample=&quot;false&quot;--&gt;</span><br><span class="hljs-comment">&lt;!--               enableDeleteByExample=&quot;false&quot; enableSelectByExample=&quot;false&quot;--&gt;</span><br><span class="hljs-comment">&lt;!--               selectByExampleQueryId=&quot;false&quot;&gt;&lt;/table&gt;--&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">context</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">generatorConfiguration</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>参考博客：<a target="_blank" rel="noopener" href="https://blog.csdn.net/hh680821/article/details/79051870">https://blog.csdn.net/hh680821/article/details/79051870</a></p>
<p>注意，如果生成代码文件时出现withBlob时，那是由于当表中有Text类型的字段时，generator会生成WithBLOBS.java文件并继承entity，同时具有带有text等类型字段的属性。</p>
<p><img src="/2021/11/21/spring%E9%9B%86%E6%88%90mybatis/20181019114518117" alt="img"></p>
<p><img src="/2021/11/21/spring%E9%9B%86%E6%88%90mybatis/20181019114330691" alt="img"></p>
<p>想要将这两个属性合并到entity中需要在xml添加如下配置即可，这样就不会生成WithBLOBS.java文件了</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">table</span> <span class="hljs-attr">tableName</span>=<span class="hljs-string">&quot;table-name&quot;</span> <span class="hljs-attr">domainObjectName</span>=<span class="hljs-string">&quot;entity&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">columnOverride</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;title&quot;</span> <span class="hljs-attr">javaType</span>=<span class="hljs-string">&quot;java.lang.String&quot;</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">&quot;VARCHAR&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">columnOverride</span> <span class="hljs-attr">column</span>=<span class="hljs-string">&quot;content&quot;</span> <span class="hljs-attr">javaType</span>=<span class="hljs-string">&quot;java.lang.String&quot;</span> <span class="hljs-attr">jdbcType</span>=<span class="hljs-string">&quot;VARCHAR&quot;</span> /&gt;</span> <br><span class="hljs-tag">&lt;/<span class="hljs-name">table</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>注意当出现生成的代码的属性与数据库字段不一致的时候，这时由于获取表结构是从mysql的schema中获取的，并不是直接或取得table结构。如果多个库中存在多个重名的表那就回出现错乱。可在连接数据库时增加配置项解决该问题</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">jdbcConnection</span></span><br><span class="hljs-tag">            <span class="hljs-attr">driverClass</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.driver&#125;&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">connectionURL</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.url&#125;&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">userId</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.username&#125;&quot;</span></span><br><span class="hljs-tag">            <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;$&#123;jdbc.database.password&#125;&quot;</span>&gt;</span><br>            <span class="hljs-comment">&lt;!--因为获取表结构是从mysql的schema中获取的，并不是直接或取得table结构。如果多个库中存在多个重名的表那就回出现错乱。可增加配置项解决该问题--&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;nullCatalogMeansCurrent&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">jdbcConnection</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>踩坑记录：  &lt; properties resource=”database-config.properties” /&gt;这个数据库配置引入应该放在前面，如果放在其它位置则会出现错误。</p>
<div id="paginator"></div></div><p><strong>本文标题</strong>：spring集成mybatis<br><strong>本文作者</strong>：MaoZH<br><strong>本文链接</strong>：<a href="/2021/11/21/spring%E9%9B%86%E6%88%90mybatis/">https://jack-edward.github.io/2021/11/21/spring%E9%9B%86%E6%88%90mybatis/</a><br><strong>版权声明</strong>：转载或借鉴请注明出处，保留以上声明信息！</p><div class="post_share"><div class="social-share share-component" data-image="https://cdn.jsdelivr.net/gh/hassanblog/CDN/img/cover_character_drawing.png" data-sites="facebook,twitter,wechat,weibo,qq,qzone,tencent,douban,diandian,google,linkedin"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="all" onload="this.media=&quot;all&quot;"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer=""></script></div><div id="post-footer"><hr><a href="/2021/10/24/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98/">每日一题 Next →</a><hr></div><div id="bottom-btn"><a id="to-index" href="#post-index" title="index">≡</a><a id="to-top" href="#post-title" title="to top">∧</a></div><div id="Valine"></div><script>new Valine({
 el: '#Valine'
 , appId: 'TWFe26C7GQDWyvw3lVpQUswj-gzGzoHsz'
 , appKey: 'kA8WG8bPJQ16UwOnhf7TGdHn'
 , placeholder: '欢迎大家评论，感谢批评指正'
})</script></div></article><aside><form><div class="tipue_search_group"><input id="tipue_search_input" type="text" name="q" placeholder="Search Here" pattern=".{3,}" title="At least 3 characters" autofocus="autofocus" required=""><button class="tipue_search_button" type="submit"><div class="tipue_search_icon">⚲</div></button></div></form><div id="tipue_search_content"></div><script>$(document).ready(function() {
$('#tipue_search_input').tipuesearch();
});</script><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><div id="he-plugin-standard"></div><script>WIDGET = {
"CONFIG": {
"layout": "1",
"width": 450,
"height": 150,
"background": "3",
"dataColor": "FFFFFF",
"key": "e2043117ad6d459bb0eb89b26de1b4a2"
}
}</script><script src="https://widget.qweather.net/standard/static/js/he-standard-common.js?v=2.0"></script><h1 id="dr"><a href="/"> Mr.MaoZH</a></h1><section id="total"><a id="total-archives" href="/archives"><span class="total-title">Archives Total:</span><span class="total-number">8</span></a><div id="total-tags"><span class="total-title">Tags:</span><span class="total-number">9</span></div><div id="total-categories"><span class="total-title">Categories:</span><span class="total-number">5</span></div></section></div><div id="about-me"><span class="about-me">Contact-me:</span><a href="tencent://message/?uin=3128633651&amp;amp;site=qq&amp;amp;menu=yes"><img src="https://im.qq.com/favicon.ico"></a><a href="mailto:3128633651@qq.com"><img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/social/email.svg" width="20"></a></div><div id="aside-block"><div id="aside"><h1>INDEX</h1><div id="post-index"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-mybatis%E4%BD%BF%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">Spring-mybatis使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E9%A1%B9%E7%9B%AE%E5%AE%9E%E4%BE%8B"><span class="toc-number">1.1.</span> <span class="toc-text">一、项目实例</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E5%AF%BC%E5%85%A5%E7%9B%B8%E5%85%B3%E4%BE%9D%E8%B5%96"><span class="toc-number">1.1.1.</span> <span class="toc-text">1.导入相关依赖</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%9F%BA%E6%9C%AC%E7%8E%AF%E5%A2%83"><span class="toc-number">1.1.2.</span> <span class="toc-text">2.基本环境</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">1.1.3.</span> <span class="toc-text">3.配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E9%85%8D%E7%BD%AESqlSessionTemplate%E7%BB%84%E4%BB%B6%EF%BC%88%E6%89%A9%E5%B1%95%EF%BC%89"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">配置SqlSessionTemplate组件（扩展）</span></a></li></ol></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring%E4%B8%8EMyBatis%E4%BA%8B%E5%8A%A1"><span class="toc-number">2.</span> <span class="toc-text">Spring与MyBatis事务</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB%E4%B8%8E%E4%BC%A0%E6%92%AD%E8%A1%8C%E4%B8%BA"><span class="toc-number">2.1.</span> <span class="toc-text">一、数据库隔离级别与传播行为</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E6%95%B0%E6%8D%AE%E5%BA%93%E9%9A%94%E7%A6%BB%E7%BA%A7%E5%88%AB"><span class="toc-number">2.1.1.</span> <span class="toc-text">1.数据库隔离级别</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Spring%E7%9A%847%E7%A7%8D%E4%BC%A0%E6%92%AD%E8%A1%8C%E4%B8%BA"><span class="toc-number">2.1.2.</span> <span class="toc-text">2.Spring的7种传播行为</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E5%A3%B0%E6%98%8E%E5%BC%8F%E4%BA%8B%E5%8A%A1"><span class="toc-number">2.1.3.</span> <span class="toc-text">3.声明式事务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-spring-mybatis%E7%BB%84%E5%90%88%E4%BD%BF%E7%94%A8%E4%BA%8B%E5%8A%A1"><span class="toc-number">2.1.4.</span> <span class="toc-text">4.spring+mybatis组合使用事务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5-%E6%B3%A8%E6%84%8F"><span class="toc-number">2.1.5.</span> <span class="toc-text">5.注意</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mybatisGenerator%E4%BD%BF%E7%94%A8"><span class="toc-number">3.</span> <span class="toc-text">mybatisGenerator使用</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E5%AF%BC%E5%85%A5maven%E6%9E%84%E5%BB%BA%E5%8C%85%E9%85%8D%E7%BD%AE"><span class="toc-number">3.1.</span> <span class="toc-text">1.导入maven构建包配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-resources%E4%B8%8B%E5%88%9B%E5%BB%BAgeneratorConfig-xml"><span class="toc-number">3.2.</span> <span class="toc-text">2.resources下创建generatorConfig.xml</span></a></li></ol></li></ol></div><div id="post-index"></div></div></div><footer><nobr><span class="text-title">©</span><span class="text-content">2020 to 2021</span></nobr><wbr><nobr><span class="text-title">ICP</span><span class="text-content">——备案号——</span></nobr><wbr><wbr><nobr>published with&nbsp;<a href="https://jack-edward.github.io">Zhihui Mao&nbsp;</a></nobr><wbr><nobr>Theme&nbsp;<a href="">Arknight&nbsp;</a></nobr><wbr><nobr>by&nbsp;<a href="">Yue_plus </a></nobr><wbr><script type="text/javascript" src="jquery.min.js"></script><script type="text/javascript">$(document).ready(function(){
//通过调用新浪IP地址库接口查询用户当前所在国家、省份、城市、运营商信息
$.getScript('https://pv.sohu.com/cityjson?ie=utf-8',function(){
$(".city").html(returnCitySN.cname);
$(".ip").html(returnCitySN.cip);
//$(".browser").html(navigator.appVersion);
});
});</script></footer><div>欢迎来自<span class="city"></span>地区的朋友<br>您的IP地址为：<span class="ip"></span><!--| <br>您的浏览器为：--><!--span.browser--><wbr><script type="text/javascript" src="//rf.revolvermaps.com/0/0/1.js?i=52al2pyccg1&amp;s=216&amp;m=0&amp;v=true&amp;r=false&amp;b=000000&amp;n=false&amp;c=ff0000" async="async"></script><wbr><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=406086764&auto=0&height=66"></iframe></div></aside></main><canvas id="canvas-dust"></canvas><script src="/js/arknights.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script></body></html>