<!DOCTYPE html><html lang="en"><script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"><script src="/live2d-widget/autoload.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="/tipuesearch/tipuesearch_content.js"></script><link rel="stylesheet" href="/tipuesearch/tipuesearch.css"><script src="/tipuesearch/tipuesearch_set.js"></script><script src="/tipuesearch/tipuesearch.min.js"></script><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Lock | MaoZH</title><script src="https://cdn.bootcss.com/valine/1.4.4/Valine.min.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/mermaid/8.11.0/mermaid.min.js"></script><script>mermaid.initialize({
  startOnLoad: true
  , theme: 'dark'
});</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="MaoZH" type="application/atom+xml">
</head><body><header><nav><a href="/">Home</a><a href="/archives/">Archives</a></nav></header><main><article><div id="post-bg"><div id="post-title"><div id="post-info"><span>date:<time datetime="2021-09-20T13:38:57.000Z" id="date"> 2021-09-20</time></span><br><span>updated:<time datetime="2021-10-05T18:23:33.883Z" id="updated"> 2021-10-06</time></span></div><h1>Lock</h1><hr></div><div id="post-content"><h2 id="锁机制"><a href="#锁机制" class="headerlink" title="锁机制"></a>锁机制</h2><p>==Java对象头==</p>
<p>普通对象</p>
<span id="more"></span> 

<figure class="highlight ruby"><table><tr><td class="code"><pre><code class="hljs ruby"><span class="hljs-params">|--------------------------------------------------------------|</span><br><span class="hljs-params">| 					Object Header (64 bits) 				   |</span><br><span class="hljs-params">|------------------------------------|</span>-------------------------<span class="hljs-params">|</span><br><span class="hljs-params">|</span> Mark Word (<span class="hljs-number">32</span> bits) 				 <span class="hljs-params">| Klass Word (32 bits)    |</span><br><span class="hljs-params">|------------------------------------|</span>-------------------------<span class="hljs-params">|</span><br></code></pre></td></tr></table></figure>

<p>数组对象</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><code class="hljs ruby"><span class="hljs-params">|---------------------------------------------------------------------------------|</span><br><span class="hljs-params">|							 Object Header (96 bits) 							  |</span><br><span class="hljs-params">|--------------------------------|</span>-----------------------<span class="hljs-params">|------------------------|</span><br><span class="hljs-params">| Mark Word(32bits) 			 |</span> Klass Word(32bits) 	 <span class="hljs-params">| array length(32bits)   |</span><br><span class="hljs-params">|--------------------------------|</span>-----------------------<span class="hljs-params">|------------------------|</span><br></code></pre></td></tr></table></figure>

<p>其中MarkWord结构如下</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><code class="hljs ruby"><span class="hljs-params">|-------------------------------------------------------|</span>--------------------<span class="hljs-params">|</span><br><span class="hljs-params">|</span> 				Mark Word (<span class="hljs-number">32</span> bits) 					<span class="hljs-params">| 		State 		 |</span><br><span class="hljs-params">|-------------------------------------------------------|</span>--------------------<span class="hljs-params">|</span><br><span class="hljs-params">|</span> <span class="hljs-symbol">hashcode:</span><span class="hljs-number">25</span> 		  <span class="hljs-params">| age:4 |</span> <span class="hljs-symbol">biased_lock:</span><span class="hljs-number">0</span> <span class="hljs-params">| 01 		|</span> 		Normal 		 <span class="hljs-params">|</span><br><span class="hljs-params">|</span>-------------------------------------------------------<span class="hljs-params">|--------------------|</span><br><span class="hljs-params">| thread:23 |</span> <span class="hljs-symbol">epoch:</span><span class="hljs-number">2</span> <span class="hljs-params">| age:4 |</span> <span class="hljs-symbol">biased_lock:</span><span class="hljs-number">1</span> <span class="hljs-params">| 01 		|</span> 		Biased 		 <span class="hljs-params">|</span><br><span class="hljs-params">|</span>-------------------------------------------------------<span class="hljs-params">|--------------------|</span><br><span class="hljs-params">| 			ptr_to_lock_record:30 			  |</span> <span class="hljs-number">00</span> 		<span class="hljs-params">| Lightweight Locked |</span><br><span class="hljs-params">|-------------------------------------------------------|</span>--------------------<span class="hljs-params">|</span><br><span class="hljs-params">|</span> 		<span class="hljs-symbol">ptr_to_heavyweight_monitor:</span><span class="hljs-number">30</span> 		  <span class="hljs-params">| 10 		|</span> Heavyweight Locked <span class="hljs-params">|</span><br><span class="hljs-params">|</span>-------------------------------------------------------<span class="hljs-params">|--------------------|</span><br><span class="hljs-params">| 											  |</span> <span class="hljs-number">11</span> 		<span class="hljs-params">| 	Marked <span class="hljs-keyword">for</span> GC    |</span><br><span class="hljs-params">|-------------------------------------------------------|</span>--------------------<span class="hljs-params">|</span><br></code></pre></td></tr></table></figure>

<p>64位虚拟机MarkWord</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><code class="hljs ruby"><span class="hljs-params">|--------------------------------------------------------------------|</span>------------------<span class="hljs-params">|</span><br><span class="hljs-params">|</span> 						Mark Word (<span class="hljs-number">64</span> bits) 						 <span class="hljs-params">| 		State 		|</span><br><span class="hljs-params">|--------------------------------------------------------------------|</span>------------------<span class="hljs-params">|</span><br><span class="hljs-params">|</span> <span class="hljs-symbol">unused:</span><span class="hljs-number">25</span> <span class="hljs-params">| hashcode:31 |</span> <span class="hljs-symbol">unused:</span><span class="hljs-number">1</span> <span class="hljs-params">| age:4 |</span> <span class="hljs-symbol">biased_lock:</span><span class="hljs-number">0</span> <span class="hljs-params">| 01 	 |</span> 		Normal 		<span class="hljs-params">|</span><br><span class="hljs-params">|</span>--------------------------------------------------------------------<span class="hljs-params">|------------------|</span><br><span class="hljs-params">| thread:54 	|</span> <span class="hljs-symbol">epoch:</span><span class="hljs-number">2</span> <span class="hljs-params">| unused:1 |</span> <span class="hljs-symbol">age:</span><span class="hljs-number">4</span> <span class="hljs-params">| biased_lock:1 |</span> <span class="hljs-number">01</span> 	 <span class="hljs-params">| 		Biased 		|</span><br><span class="hljs-params">|--------------------------------------------------------------------|</span>------------------<span class="hljs-params">|</span><br><span class="hljs-params">|</span> 						<span class="hljs-symbol">ptr_to_lock_record:</span><span class="hljs-number">62</span> 				 <span class="hljs-params">| 00    |</span>Lightweight Locked<span class="hljs-params">|</span><br><span class="hljs-params">|</span>--------------------------------------------------------------------<span class="hljs-params">|------------------|</span><br><span class="hljs-params">| 						ptr_to_heavyweight_monitor:62 		 |</span> <span class="hljs-number">10</span>    <span class="hljs-params">|Heavyweight Locked|</span><br><span class="hljs-params">|--------------------------------------------------------------------|</span>------------------<span class="hljs-params">|</span><br><span class="hljs-params">|</span> 															 <span class="hljs-params">| 11 	 |</span>   Marked <span class="hljs-keyword">for</span> GC  <span class="hljs-params">|</span><br><span class="hljs-params">|</span>--------------------------------------------------------------------<span class="hljs-params">|------------------|</span><br></code></pre></td></tr></table></figure>

<p>比如：一个Integer对象的对象头是8byte，一个int为4byte，一个Integer对象内含一个int值总共12byte</p>
<p>参考博客：<a target="_blank" rel="noopener" href="https://blog.dreamtobe.cn/2015/11/13/java_synchronized/">https://blog.dreamtobe.cn/2015/11/13/java_synchronized/</a></p>
<p>==Monitor锁(JVM层面)==</p>
<p>Monitor称为监视器或管程</p>
<p>每个Java对象都可以关联一个Monitor对象，当使用synchronized给对象上重量级锁后，该对象头的MarkWord中</p>
<p><img src="/2021/09/20/Lock-0/image-20210915225138608-1632143620306.png" alt="image-20210915225138608"></p>
<p><img src="/2021/09/20/Lock-0/image-20210915224600836-1632143620306.png" alt="image-20210915224600836"></p>
<p>相应对象的对象头将会记录该Monitor锁的地址</p>
<p>1.起初 Monitor 中 Owner 为 null</p>
<p>2.当 Thread-2 执行 synchronized(obj) 就会将 Monitor 的所有者 Owner 置为 Thread-2，Monitor中只能有一 个 Owner</p>
<p>3.在 Thread-2 上锁的过程中，如果 Thread-3，Thread-4，Thread-5 也来执行 synchronized(obj)，就会进入 EntryList 处于BLOCKED状态</p>
<p>4.Thread-2 执行完同步代码块的内容，然后唤醒 EntryList 中等待的线程来竞争锁，竞争的时是非公平的</p>
<p>5.WaitSet 中的 Thread-0，Thread-1 是之前获得过锁，但条件不满足进入 WAITING 状态的线程，后面讲 wait-notify 时会分析</p>
<p>==字节码看synchronized原理==</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Object lock = <span class="hljs-keyword">new</span> Object();<br><span class="hljs-keyword">static</span> <span class="hljs-keyword">int</span> counter = <span class="hljs-number">0</span>;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br> <span class="hljs-keyword">synchronized</span> (lock) &#123;<br> counter++;<br> &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>反编译产生的字节码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(java.lang.String[])</span></span>;<br> descriptor: ([Ljava/lang/String;)V<br> flags: ACC_PUBLIC, ACC_STATIC<br> Code:<br> 	stack=<span class="hljs-number">2</span>, locals=<span class="hljs-number">3</span>, args_size=<span class="hljs-number">1</span><br>     <span class="hljs-number">0</span>: getstatic #<span class="hljs-number">2</span> <span class="hljs-comment">// &lt;- lock引用 （synchronized开始）</span><br>     <span class="hljs-number">3</span>: dup<br>     <span class="hljs-number">4</span>: astore_1 <span class="hljs-comment">// lock引用 -&gt; slot 1</span><br>     <span class="hljs-number">5</span>: monitorenter <span class="hljs-comment">// 将 lock对象 MarkWord 置为 Monitor 指针</span><br>     <span class="hljs-number">6</span>: getstatic #<span class="hljs-number">3</span> <span class="hljs-comment">// &lt;- i</span><br>     <span class="hljs-number">9</span>: iconst_1 <span class="hljs-comment">// 准备常数 1</span><br>     <span class="hljs-number">10</span>: iadd <span class="hljs-comment">// +1</span><br>     <span class="hljs-number">11</span>: putstatic #<span class="hljs-number">3</span> <span class="hljs-comment">// -&gt; i</span><br>     <span class="hljs-number">14</span>: aload_1 <span class="hljs-comment">// &lt;- lock引用</span><br>     <span class="hljs-number">15</span>: monitorexit <span class="hljs-comment">// 将 lock对象 MarkWord 重置, 唤醒 EntryList</span><br>     <span class="hljs-number">16</span>: goto <span class="hljs-number">24</span><br>     <span class="hljs-comment">//抛出异常时执行，同样释放锁还原markword</span><br>     <span class="hljs-number">19</span>: astore_2 <span class="hljs-comment">// e -&gt; slot 2</span><br>     <span class="hljs-number">20</span>: aload_1 <span class="hljs-comment">// &lt;- lock引用</span><br>     <span class="hljs-number">21</span>: monitorexit <span class="hljs-comment">// 将 lock对象 MarkWord 重置, 唤醒 EntryList</span><br>     <span class="hljs-number">22</span>: aload_2 <span class="hljs-comment">// &lt;- slot 2 (e)</span><br>     <span class="hljs-number">23</span>: athrow <span class="hljs-comment">// throw e</span><br>     <span class="hljs-number">24</span>: <span class="hljs-keyword">return</span><br>     Exception table:<br>     from to target type<br>     <span class="hljs-number">6</span> <span class="hljs-number">16</span> <span class="hljs-number">19</span> any<br>     <span class="hljs-number">19</span> <span class="hljs-number">22</span> <span class="hljs-number">19</span> any<br>     LineNumberTable:<br>     line <span class="hljs-number">8</span>: <span class="hljs-number">0</span><br>     line <span class="hljs-number">9</span>: <span class="hljs-number">6</span><br>     line <span class="hljs-number">10</span>: <span class="hljs-number">14</span><br>     line <span class="hljs-number">11</span>: <span class="hljs-number">24</span><br>     LocalVariableTable:<br>     Start Length Slot Name Signature<br>     <span class="hljs-number">0</span> <span class="hljs-number">25</span> <span class="hljs-number">0</span> args [Ljava/lang/String;<br>     StackMapTable: number_of_entries = <span class="hljs-number">2</span><br>     frame_type = <span class="hljs-number">255</span> <span class="hljs-comment">/* full_frame */</span><br>     offset_delta = <span class="hljs-number">19</span><br>     locals = [ <span class="hljs-class"><span class="hljs-keyword">class</span> &quot;[<span class="hljs-title">Ljava</span>/<span class="hljs-title">lang</span>/<span class="hljs-title">String</span></span>;<span class="hljs-string">&quot;, class java/lang/Object ]</span><br><span class="hljs-string">     stack = [ class java/lang/Throwable ]</span><br><span class="hljs-string">     frame_type = 250 /* chop */</span><br><span class="hljs-string">     offset_delta = 4</span><br><span class="hljs-string"></span><br></code></pre></td></tr></table></figure>

<p>注意：方法级别的Synchronized不会在字节码指令中体现</p>
<h2 id="Synchronized-进阶"><a href="#Synchronized-进阶" class="headerlink" title="Synchronized 进阶"></a>Synchronized 进阶</h2><p><strong>1.轻量级锁</strong></p>
<p>当一个对象被多个线程使用，多个线程对其加锁的时间是错开的(没有竞争)，此时采用轻量级锁</p>
<p>轻量级锁的实现封装在Synchronized 中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//以这段代码为例看加锁流程</span><br><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Object obj = <span class="hljs-keyword">new</span> Object();<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method1</span><span class="hljs-params">()</span> </span>&#123;<br>         <span class="hljs-keyword">synchronized</span>( obj ) &#123;<br>         <span class="hljs-comment">// 同步块 A</span><br>         method2();<br>     &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method2</span><span class="hljs-params">()</span> </span>&#123;<br>         <span class="hljs-keyword">synchronized</span>( obj ) &#123;<br>         <span class="hljs-comment">// 同步块 B</span><br>     &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>1.Thread0线程创建锁记录LockRecord对象(JVM层面)，每个线程都的栈帧都会包含一个锁记录的结构，内部可以存储锁定对象的 Mark Word</p>
<p><img src="/2021/09/20/Lock-0/image-20210915231340226-1632143620307.png" alt="image-20210915231340226"></p>
<p>2.当synchronized加锁时，锁记录中 Object reference 指向锁对象，并尝试用 cas 替换 Object 的 Mark Word，将 Mark Word 的值存入锁记录</p>
<p><img src="/2021/09/20/Lock-0/image-20210915231455686-1632143620307.png" alt="image-20210915231455686"></p>
<p>3.若CAS替换成功，对象头中存储了锁记录地址以及轻量级加锁状态00，表示由该线程给对象加锁，原来锁记录的锁记录地址就变为对象头的markword记录对象的hashcode,分代年龄偏向状态以及加锁状态</p>
<p><img src="/2021/09/20/Lock-0/image-20210915231836547-1632143620307.png" alt="image-20210915231836547"></p>
<p>4.如果CAS失败，分两种情况</p>
<ul>
<li><p>1.如果是自己执行了synchronized 锁重入，那么该线程栈帧新添加一个锁记录，此时CAS发现加锁状态已经是00轻量锁的状态，CAS失败，但是由于锁已经绑定当前线程的另一条锁记录，此时锁记录置为Null并且会将锁重入的计数加1</p>
<p><img src="/2021/09/20/Lock-0/image-20210915232801386-1632143620307.png" alt="image-20210915232801386"><br>2.当退出 synchronized 代码块时，如果是取值为 null 的锁记录，表示有锁重入，这时清除锁记录，表示重入计数减1</p>
</li>
<li><p>如果是其它线程已经持有了该 Object 的轻量级锁，这时表明有竞争，进入锁膨胀过程</p>
</li>
</ul>
<p>5.当退出 synchronized 代码块时，如果锁记录的值不为null，这时使用CAS将对象头当中的MarkWord恢复，即还原原来的hashcode,分代年龄偏向状态以及加锁状态。</p>
<p>6.如果操作成功，解锁成功；如果失败，说明轻量级锁进行了锁膨胀或者已经升级为重量级锁，进入重量级锁解锁流程</p>
<p><strong>2.锁膨胀</strong></p>
<p>在尝试加轻量级锁过程中，CAS操作无法成功，一种情况就是有其他线程对此对象已经加上了轻量级锁，这时会发生锁膨胀，轻量级锁变为重量级锁</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Thread1</span><br><span class="hljs-keyword">static</span> Object obj = <span class="hljs-keyword">new</span> Object();<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">method1</span><span class="hljs-params">()</span> </span>&#123;<br>     <span class="hljs-keyword">synchronized</span>( obj ) &#123;<br>     <span class="hljs-comment">// 同步块</span><br>     &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>1.当另一个线程Thread1要加轻量级锁时，但是此时Thread0已经对该对象加了轻量级锁，此时进行CAS时失败</p>
<p><img src="/2021/09/20/Lock-0/image-20210915234209725-1632143620307.png" alt="image-20210915234209725"></p>
<p>2.Thread1加轻量级锁失败，进入锁膨胀流程</p>
<ul>
<li>为加锁对象Object申请Monitor锁，该对象的对象头的MarkWord变为指向重量级锁Monitor的地址Thread进入到Monitor对象的EntryList当中进入阻塞等待状态，同时Monitor的Owner会指向当前Thread0的锁记录</li>
</ul>
<p><img src="/2021/09/20/Lock-0/image-20210915235307588-1632143620307.png" alt="image-20210915235307588"></p>
<p>3.当Thread0退出同步锁解锁时，由于锁已经升级为重量级锁状态，使用CAS恢复MarkWord失败，此时进入重量级锁解锁流程：</p>
<p>先按照Monitor地址找到Monitor对象，将Owner置为空，唤醒EntryList当中的线程，让其中一个线程获得该对象的重量级锁；当没有线程加锁时Monitor地址将变为最后一个锁记录的地址，最后进行CAS恢复对象头MarkWord</p>
<img src="/2021/09/20/Lock-0/1631721641280.jpg.jpg" alt="1631721641280.jpg" style="zoom:150%;">

<p><strong>自旋优化</strong></p>
<p>重量级锁竞争时可以使用自旋(在有线程占用锁的时候其他线程进行循环尝试加锁)来进行优化，如果当前线程自选成功，可以避免当前线程阻塞(阻塞会发生上下文切换，耗费资源)，充分利用cpu资源</p>
<p>==自选加锁成功==</p>
<p><img src="/2021/09/20/Lock-0/image-20210916225247972-1632143620307.png" alt="image-20210916225247972"></p>
<p>==自旋加锁失败==</p>
<p><img src="/2021/09/20/Lock-0/image-20210916225315806-1632143620307.png" alt="image-20210916225315806"></p>
<p>自旋能够充分提升多核cpu的效率，在java6后自旋锁是自适应的，比如对象刚刚一次自旋操作成功则认为这次自旋成功的可能性高，会多进行几次自旋；反之就少自旋甚至不自旋</p>
<p><strong>3.偏向锁</strong></p>
<p>轻量级锁在没有竞争时（本身线程），每次重入仍然需要执行 CAS 操作。<br>Java 6 中引入了偏向锁来做进一步优化：只有第一次使用 CAS 将线程 ID 设置到对象的 Mark Word 头，之后发现 这个线程 ID 是自己的就表示没有竞争，不用重新 CAS。以后只要不发生竞争，这个对象就归该线程所有</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Object obj = <span class="hljs-keyword">new</span> Object();<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">m1</span><span class="hljs-params">()</span> </span>&#123;<br>     <span class="hljs-keyword">synchronized</span>( obj ) &#123;<br>     	<span class="hljs-comment">// 同步块 A</span><br>     	m2();<br>     &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">m2</span><span class="hljs-params">()</span> </span>&#123;<br>     <span class="hljs-keyword">synchronized</span>( obj ) &#123;<br>         <span class="hljs-comment">// 同步块 B</span><br>         m3();<br>     &#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">m3</span><span class="hljs-params">()</span> </span>&#123;<br>     <span class="hljs-keyword">synchronized</span>( obj ) &#123;<br>          <span class="hljs-comment">// 同步块 C</span><br>     &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2021/09/20/Lock-0/image-20210916230912193-1632143620307.png" alt="image-20210916230912193"></p>
<p>使用偏向锁后就不需要CAS操作，直接判断线程ID</p>
<p><img src="/2021/09/20/Lock-0/image-20210916230854627-1632143620307.png" alt="image-20210916230854627"></p>
<p>==偏向状态==</p>
<p>对象创建时：</p>
<ul>
<li>默认开启偏向锁，对象创建后，markword 值为 0x05 即最后 3 位为 101，这时它的 thread、epoch、age 都为 0</li>
<li>偏向锁是默认是延迟的，不会在程序启动时立即生效，可以加VM参数==-XX:BiasedLockingStartupDelay=0==禁用延迟</li>
</ul>
<p>使用jol第三方工具读取markword的值，用于测试</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.openjdk.jol<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>jol-core<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>0.16<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>provided<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>1)延迟特性</p>
<p>2)偏向锁</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestBiased</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Lock lock = <span class="hljs-keyword">new</span> Lock();<br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            System.out.println(<span class="hljs-string">&quot;synchronized前&quot;</span>);<br>            System.out.println(ClassLayout.parseInstance(lock).toPrintable());<br>            <span class="hljs-keyword">synchronized</span> (lock) &#123;<br>                System.out.println(<span class="hljs-string">&quot;synchronized中&quot;</span>);<br>                System.out.println(ClassLayout.parseInstance(lock).toPrintable());<br>            &#125;<br>            System.out.println(<span class="hljs-string">&quot;synchronized后&quot;</span>);<br>            System.out.println(ClassLayout.parseInstance(lock).toPrintable());<br>        &#125;,<span class="hljs-string">&quot;t1&quot;</span>).start();<br>    &#125;<br>&#125;<br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Lock</span></span>&#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2021/09/20/Lock-0/image-20210916232830431-1632143620307.png" alt="image-20210916232830431"></p>
<p>处于偏向锁的对象解锁后，线程 id 仍存储于对象头中</p>
<p>3)禁用</p>
<p>通过添加VM参数-XX:-UseBiasedLocking禁用偏向锁</p>
<p><img src="/2021/09/20/Lock-0/image-20210916233239252-1632143620307.png" alt="image-20210916233239252"></p>
<p>4)调用hashcode也会禁用偏向锁</p>
<p>正常状态对象一开始是没有 hashCode 的，第一次调用才生成，上述代码调用hashcode就会禁用偏向锁</p>
<p>原因：hashcode在markword占用31位，使用偏向锁后无法存入hashcode</p>
<blockquote>
<p>撤销-调用对象的hashCode</p>
</blockquote>
<p>调用了对象的 hashCode，但偏向锁的对象 MarkWord 中存储的是线程 id，没有多余的空间存储hashcode，如果调用 hashCode 会导致偏向锁被撤销，转而使用轻量锁</p>
<ul>
<li>轻量级锁会在锁记录中记录hashcode</li>
<li>重量级锁会在monitor中记录hashcode</li>
</ul>
<blockquote>
<p>撤销-其他线程对该对象加锁</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestBiased2</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Lock lock = <span class="hljs-keyword">new</span> Lock();<br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            <span class="hljs-keyword">synchronized</span> (lock) &#123;<br>                System.out.println(ClassLayout.parseInstance(lock).toPrintable());<span class="hljs-comment">//0101</span><br>            &#125;<br>            <span class="hljs-keyword">synchronized</span> (TestBiased2.class) &#123;<br>                TestBiased2.class.notify();<br>            &#125;<br>        &#125;).start();<br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            <span class="hljs-keyword">synchronized</span> (TestBiased2.class) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    TestBiased2.class.wait();<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>                System.out.println(ClassLayout.parseInstance(lock).toPrintable());<span class="hljs-comment">//0101</span><br>                <span class="hljs-keyword">synchronized</span> (lock) &#123;<br>                    System.out.println(ClassLayout.parseInstance(lock).toPrintable());<span class="hljs-comment">//0000,解除偏向锁</span><br>                &#125;<br>                System.out.println(ClassLayout.parseInstance(lock).toPrintable());<span class="hljs-comment">//0001</span><br>            &#125;<br>        &#125;,<span class="hljs-string">&quot;t2&quot;</span>).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2021/09/20/Lock-0/image-20210916234915082-1632143620307.png"></p>
<p>当有其它线程使用该对象对其加锁时，偏向锁会撤销变为轻量级锁</p>
<blockquote>
<p>撤销-调用wait/notify</p>
</blockquote>
<p>因为wait/notify使用时是在重量级锁下的，肯定会撤销偏向锁</p>
<p>==批量重偏向==</p>
<p>对象虽然被多个线程访问，但没有竞争，这时偏向了线程 T1 的对象仍有机会重新偏向 T2，重偏向会重置对象 的 Thread ID，当撤销偏向锁阈值超过20次后JVM会认为目前的偏向状态是错误的，于是会在给这些对象加锁时重新偏向至加锁线程</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestBiased3</span> </span>&#123;<br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>&#123;<br>        Vector&lt;Lock&gt; list = <span class="hljs-keyword">new</span> Vector&lt;&gt;();<br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">30</span>; i++) &#123;<span class="hljs-comment">//从i=0开始就偏向线程t1了,1000</span><br>                Lock lock = <span class="hljs-keyword">new</span> Lock();<br>                System.out.println(i + <span class="hljs-string">&quot;\t&quot;</span> + ClassLayout.parseInstance(lock).toPrintable());<br>                list.add(lock);<br>                <span class="hljs-keyword">synchronized</span> (lock) &#123;<br>                    System.out.println(i + <span class="hljs-string">&quot;\t&quot;</span> + ClassLayout.parseInstance(lock).toPrintable());<br>                &#125;<br>            &#125;<br>            <span class="hljs-keyword">synchronized</span> (list) &#123;<br>                list.notify();<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>).start();<br><br>        <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            <span class="hljs-keyword">synchronized</span> (list) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    list.wait();<br>                &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>                    e.printStackTrace();<br>                &#125;<br>            &#125;<br>            System.out.println(<span class="hljs-string">&quot;==========================&quot;</span>);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">30</span>; i++) &#123;<span class="hljs-comment">//前19个都是将偏向锁依然偏向t1,第20个及以后改为偏向t2</span><br>                Lock lock = list.get(i);<br>                System.out.println(i + <span class="hljs-string">&quot;\t&quot;</span> + ClassLayout.parseInstance(lock).toPrintable());<br>                <span class="hljs-keyword">synchronized</span> (lock) &#123;<br>                    System.out.println(i + <span class="hljs-string">&quot;\t&quot;</span> + ClassLayout.parseInstance(lock).toPrintable());<br>                &#125;<br>                System.out.println(i + <span class="hljs-string">&quot;\t&quot;</span> + ClassLayout.parseInstance(lock).toPrintable());<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>).start();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>线程t1加锁时处于偏向状态，偏向t1线程</p>
<p><img src="/2021/09/20/Lock-0/image-20210917000118919-1632143620307.png" alt="image-20210917000118919"></p>
<p>当线程t2刚开始对该对象加锁时，对象的偏向状态依然是偏向线程t1的，此时t2线程对对象加锁为轻量级锁</p>
<p><img src="/2021/09/20/Lock-0/image-20210917000458627-1632143620308.png" alt="image-20210917000458627"></p>
<p>当撤销锁达到20次时，会改变偏向状态</p>
<p><img src="/2021/09/20/Lock-0/image-20210917000646372-1632143620308.png" alt="image-20210917000646372"></p>
<p>==批量撤销==</p>
<p>当撤销偏向锁阈值超过 40 次后，jvm 会这样认为确实偏向错了，此时该对象的使用竞争太激烈，根本就不该偏向。于是整个类的所有对象 都会变为不可偏向的，新建的对象也是不可偏向的</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestBiased4</span> </span>&#123;<br>    <span class="hljs-keyword">static</span> Thread t1, t2, t3;<br><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        test4();<br>    &#125;<br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">test4</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> InterruptedException </span>&#123;<br>        Vector&lt;Lock&gt; list = <span class="hljs-keyword">new</span> Vector&lt;&gt;();<br>        <span class="hljs-keyword">int</span> loopNumber = <span class="hljs-number">39</span>;<br>        t1 = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; loopNumber; i++) &#123;<br>                Lock lock = <span class="hljs-keyword">new</span> Lock();<br>                list.add(lock);<br>                <span class="hljs-keyword">synchronized</span> (lock) &#123;<br>                    System.out.println((i + <span class="hljs-string">&quot;\t&quot;</span> + ClassLayout.parseInstance(lock).toPrintable()));<br>                &#125;<br>            &#125;<br>            LockSupport.unpark(t2);<br>        &#125;, <span class="hljs-string">&quot;t1&quot;</span>);<br>        t1.start();<br>        t2 = <span class="hljs-keyword">new</span> Thread(() -&gt; &#123;<br>            LockSupport.park();<br>            System.out.println((<span class="hljs-string">&quot;================ &quot;</span>));<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; loopNumber; i++) &#123;<br>                Lock lock = list.get(i);<br>                System.out.println((i + <span class="hljs-string">&quot;\t&quot;</span> + ClassLayout.parseInstance(lock).toPrintable()));<br>                <span class="hljs-keyword">synchronized</span> (lock) &#123;<br>                    System.out.println((i + <span class="hljs-string">&quot;\t&quot;</span> + ClassLayout.parseInstance(lock).toPrintable()));<br>                &#125;<br>                System.out.println((i + <span class="hljs-string">&quot;\t&quot;</span> + ClassLayout.parseInstance(lock).toPrintable()));<br>            &#125;<br>            LockSupport.unpark(t3);<br>        &#125;, <span class="hljs-string">&quot;t2&quot;</span>);<br>        t2.start();<br>        t3 = <span class="hljs-keyword">new</span> Thread(()-&gt; &#123;<br>            LockSupport.park();<br>            System.out.println(<span class="hljs-string">&quot;=================&quot;</span>);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; loopNumber; i++) &#123;<br>                Lock lock = list.get(i);<br>                System.out.println((i + <span class="hljs-string">&quot;\t&quot;</span> + ClassLayout.parseInstance(lock).toPrintable()));<br>                <span class="hljs-keyword">synchronized</span> (lock) &#123;<br>                    System.out.println((i + <span class="hljs-string">&quot;\t&quot;</span> + ClassLayout.parseInstance(lock).toPrintable()));<br>                &#125;<br>                System.out.println((i + <span class="hljs-string">&quot;\t&quot;</span> + ClassLayout.parseInstance(lock).toPrintable()));<br>            &#125;<br>        &#125;, <span class="hljs-string">&quot;t3&quot;</span>);<br>        t3.start();<br>        t3.join();<br>        System.out.println((ClassLayout.parseInstance(<span class="hljs-keyword">new</span> Lock()).toPrintable()));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/2021/09/20/Lock-0/image-20210917001758215-1632143620308.png" alt="image-20210917001758215"></p>
<p>update</p>
<div id="paginator"></div></div><p><strong>本文标题</strong>：Lock<br><strong>本文作者</strong>：MaoZH<br><strong>本文链接</strong>：<a href="/2021/09/20/Lock-0/">https://jack-edward.github.io/2021/09/20/Lock-0/</a><br><strong>版权声明</strong>：转载或借鉴请注明出处，保留以上声明信息！</p><div class="post_share"><div class="social-share share-component" data-image="https://cdn.jsdelivr.net/gh/hassanblog/CDN/img/cover_character_drawing.png" data-sites="facebook,twitter,wechat,weibo,qq,qzone,tencent,douban,diandian,google,linkedin"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="all" onload="this.media=&quot;all&quot;"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer=""></script></div><div id="post-footer"><hr><a href="/2021/09/20/JUC/">← Prev JUC</a><hr></div><div id="bottom-btn"><a id="to-index" href="#post-index" title="index">≡</a><a id="to-top" href="#post-title" title="to top">∧</a></div><details id="reward"><summary>打赏</summary><div id="alipay"><span>支付宝 | Alipay</span><br><img src="/img/Alipay.png"></div><div id="wechat"><span>微信 | WeChat</span><br><img src="/img/WeChat.png"></div></details><div id="Valine"></div><script>new Valine({
 el: '#Valine'
 , appId: 'TWFe26C7GQDWyvw3lVpQUswj-gzGzoHsz'
 , appKey: 'kA8WG8bPJQ16UwOnhf7TGdHn'
 , placeholder: '欢迎大家评论，感谢批评指正'
})</script></div></article><aside><form><div class="tipue_search_group"><input id="tipue_search_input" type="text" name="q" placeholder="Search Here" pattern=".{3,}" title="At least 3 characters" autofocus="autofocus" required=""><button class="tipue_search_button" type="submit"><div class="tipue_search_icon">⚲</div></button></div></form><div id="tipue_search_content"></div><script>$(document).ready(function() {
$('#tipue_search_input').tipuesearch();
});</script><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><div id="he-plugin-standard"></div><script>WIDGET = {
"CONFIG": {
"layout": "1",
"width": 450,
"height": 150,
"background": "3",
"dataColor": "FFFFFF",
"key": "e2043117ad6d459bb0eb89b26de1b4a2"
}
}</script><script src="https://widget.qweather.net/standard/static/js/he-standard-common.js?v=2.0"></script><h1 id="dr"><a href="/"> Mr.MaoZH</a></h1><section id="total"><a id="total-archives" href="/archives"><span class="total-title">Archives Total:</span><span class="total-number">8</span></a><div id="total-tags"><span class="total-title">Tags:</span><span class="total-number">9</span></div><div id="total-categories"><span class="total-title">Categories:</span><span class="total-number">5</span></div></section></div><div id="about-me"><span class="about-me">Contact-me:</span><a href="tencent://message/?uin=3128633651&amp;amp;site=qq&amp;amp;menu=yes"><img src="https://im.qq.com/favicon.ico"></a><a href="mailto:3128633651@qq.com"><img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/social/email.svg" width="20"></a></div><div id="aside-block"><div id="aside"><h1>INDEX</h1><div id="post-index"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%94%81%E6%9C%BA%E5%88%B6"><span class="toc-number">1.</span> <span class="toc-text">锁机制</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Synchronized-%E8%BF%9B%E9%98%B6"><span class="toc-number">2.</span> <span class="toc-text">Synchronized 进阶</span></a></li></ol></div><div id="post-index"></div></div></div><footer><nobr><span class="text-title">©</span><span class="text-content">2020 to 2021</span></nobr><wbr><nobr><span class="text-title">ICP</span><span class="text-content">——备案号——</span></nobr><wbr><wbr><nobr>published with&nbsp;<a href="https://jack-edward.github.io">Zhihui Mao&nbsp;</a></nobr><wbr><nobr>Theme&nbsp;<a href="">Arknight&nbsp;</a></nobr><wbr><nobr>by&nbsp;<a href="">Yue_plus </a></nobr><wbr><script type="text/javascript" src="jquery.min.js"></script><script type="text/javascript">$(document).ready(function(){
//通过调用新浪IP地址库接口查询用户当前所在国家、省份、城市、运营商信息
$.getScript('https://pv.sohu.com/cityjson?ie=utf-8',function(){
$(".city").html(returnCitySN.cname);
$(".ip").html(returnCitySN.cip);
//$(".browser").html(navigator.appVersion);
});
});</script></footer><div>欢迎来自<span class="city"></span>地区的朋友<br>您的IP地址为：<span class="ip"></span><!--| <br>您的浏览器为：--><!--span.browser--><wbr><script type="text/javascript" src="//rf.revolvermaps.com/0/0/1.js?i=52al2pyccg1&amp;s=216&amp;m=0&amp;v=true&amp;r=false&amp;b=000000&amp;n=false&amp;c=ff0000" async="async"></script><wbr><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=406086764&auto=0&height=66"></iframe></div></aside></main><canvas id="canvas-dust"></canvas><script src="/js/arknights.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script></body></html>