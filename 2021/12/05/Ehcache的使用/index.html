<!DOCTYPE html><html lang="en"><script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome/css/font-awesome.min.css"><script src="/live2d-widget/autoload.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css"><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="/tipuesearch/tipuesearch_content.js"></script><link rel="stylesheet" href="/tipuesearch/tipuesearch.css"><script src="/tipuesearch/tipuesearch_set.js"></script><script src="/tipuesearch/tipuesearch.min.js"></script><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Ehcache的使用 | MaoZH</title><script src="https://cdn.bootcss.com/valine/1.4.4/Valine.min.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/mermaid/8.11.0/mermaid.min.js"></script><script>mermaid.initialize({
  startOnLoad: true
  , theme: 'dark'
});</script><link rel="stylesheet" href="/css/arknights.css"><link rel="stylesheet" href="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/styles/atom-one-dark-reasonable.min.css"><style>@font-face {
 font-family: BenderLight;
 src: local('Bender'), url("/font/BenderLight.ttf");
}
@font-face {
 font-family: 'JetBrains Mono';
 src: local('JetBrains Mono'), url('/font/JetBrainsMono-Regular.woff2') format('woff2');
}</style><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="MaoZH" type="application/atom+xml">
</head><body><header><nav><a href="/">Home</a><a href="/archives/">Archives</a><a href="/resources/">Resources</a></nav></header><main><article><div id="post-bg"><div id="post-title"><h1>Ehcache的使用</h1><hr></div><div id="post-content"><h1 id="Ehcache的使用"><a href="#Ehcache的使用" class="headerlink" title="Ehcache的使用"></a>Ehcache的使用</h1><p>部分原理解读参考博客：</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/u014209975/article/details/53320395">https://blog.csdn.net/u014209975/article/details/53320395</a></p>
<span id="more"></span>

<h2 id="1-基本介绍"><a href="#1-基本介绍" class="headerlink" title="1. 基本介绍"></a>1. 基本介绍</h2><p>EhCache 是一个纯Java的进程内缓存框架，具有快速、精干等特点，是Hibernate中默认CacheProvider。Ehcache是一种广泛使用的开源Java分布式缓存。主要面向通用缓存,Java EE和轻量级容器。它具有内存和磁盘存储，缓存加载器,缓存扩展,缓存异常处理程序,一个gzip缓存servlet过滤器,支持REST和SOAP api等特点。</p>
<p>Spring 提供了对缓存功能的抽象：即允许绑定不同的缓存解决方案（如Ehcache），但本身不直接提供缓存功能的实现。它支持注解方式使用缓存，非常方便。</p>
<h2 id="2-主要的特性有："><a href="#2-主要的特性有：" class="headerlink" title="2. 主要的特性有："></a>2. 主要的特性有：</h2><ol>
<li>快速</li>
<li>简单</li>
<li>多种缓存策略</li>
<li>缓存数据有两级：内存和磁盘，因此无需担心容量问题</li>
<li>缓存数据会在虚拟机重启的过程中写入磁盘</li>
<li>可以通过RMI、可插入API等方式进行分布式缓存</li>
<li>具有缓存和缓存管理器的侦听接口</li>
<li>支持多缓存管理器实例，以及一个实例的多个缓存区域</li>
<li>提供Hibernate的缓存实现</li>
</ol>
<h2 id="3-ehcache-和-redis-比较"><a href="#3-ehcache-和-redis-比较" class="headerlink" title="3. ehcache 和 redis 比较"></a>3. ehcache 和 redis 比较</h2><ul>
<li>ehcache直接在jvm虚拟机中缓存，速度快，效率高；但是缓存共享麻烦，集群分布式应用不方便。</li>
<li>redis是通过socket访问到缓存服务，效率比ecache低，比数据库要快很多，<br>处理集群和分布式缓存方便，有成熟的方案。如果是单个应用或者对缓存访问要求很高的应用，用ehcache。如果是大型系统，存在缓存共享、分布式部署、缓存内容很大的，建议用redis。</li>
</ul>
<p>ehcache也有缓存共享方案，不过是通过RMI或者Jgroup多播方式进行广播缓存通知更新，缓存共享复杂，维护不方便；简单的共享可以，但是涉及到缓存恢复，大数据缓存，则不合适。</p>
<h2 id="4-spring集成ehcache"><a href="#4-spring集成ehcache" class="headerlink" title="4.spring集成ehcache"></a>4.spring集成ehcache</h2><p>1.导入maven依赖</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/net.sf.ehcache/ehcache --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>net.sf.ehcache<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>ehcache<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.10.6<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-comment">&lt;!-- https://mvnrepository.com/artifact/org.springframework/spring-tx --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-tx<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.3.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-context-support<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.3.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-aspects<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>5.3.9<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>注意由于ehcache是通过动态代理实现的，因此需要导入事务transaction支持，并且需要使用到spring的context</p>
<p>2.配置ehcache.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">ehcache</span> <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">xsi:noNamespaceSchemaLocation</span>=<span class="hljs-string">&quot;ehcache.xsd&quot;</span> <span class="hljs-attr">updateCheck</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">         <span class="hljs-attr">monitoring</span>=<span class="hljs-string">&quot;autodetect&quot;</span> <span class="hljs-attr">dynamicConfig</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">diskStore</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;java.io.tmpdir&quot;</span>/&gt;</span><br>    <span class="hljs-comment">&lt;!-- &lt;diskStore path=&quot;java.io.tmpdir&quot; /&gt; --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">defaultCache</span> <span class="hljs-attr">maxElementsInMemory</span>=<span class="hljs-string">&quot;10000&quot;</span> <span class="hljs-attr">eternal</span>=<span class="hljs-string">&quot;false&quot;</span></span><br><span class="hljs-tag">                  <span class="hljs-attr">timeToIdleSeconds</span>=<span class="hljs-string">&quot;120&quot;</span> <span class="hljs-attr">timeToLiveSeconds</span>=<span class="hljs-string">&quot;120&quot;</span> <span class="hljs-attr">overflowToDisk</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">                  <span class="hljs-attr">diskSpoolBufferSizeMB</span>=<span class="hljs-string">&quot;30&quot;</span> <span class="hljs-attr">maxElementsOnDisk</span>=<span class="hljs-string">&quot;10000000&quot;</span></span><br><span class="hljs-tag">                  <span class="hljs-attr">diskPersistent</span>=<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-attr">diskExpiryThreadIntervalSeconds</span>=<span class="hljs-string">&quot;120&quot;</span></span><br><span class="hljs-tag">                  <span class="hljs-attr">memoryStoreEvictionPolicy</span>=<span class="hljs-string">&quot;LRU&quot;</span> /&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">cache</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;baseCache&quot;</span> <span class="hljs-attr">maxElementsInMemory</span>=<span class="hljs-string">&quot;10000&quot;</span> <span class="hljs-attr">eternal</span>=<span class="hljs-string">&quot;false&quot;</span></span><br><span class="hljs-tag">           <span class="hljs-attr">timeToIdleSeconds</span>=<span class="hljs-string">&quot;120&quot;</span> <span class="hljs-attr">timeToLiveSeconds</span>=<span class="hljs-string">&quot;120&quot;</span> <span class="hljs-attr">overflowToDisk</span>=<span class="hljs-string">&quot;true&quot;</span></span><br><span class="hljs-tag">           <span class="hljs-attr">diskSpoolBufferSizeMB</span>=<span class="hljs-string">&quot;30&quot;</span> <span class="hljs-attr">maxElementsOnDisk</span>=<span class="hljs-string">&quot;10000000&quot;</span></span><br><span class="hljs-tag">           <span class="hljs-attr">diskPersistent</span>=<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-attr">diskExpiryThreadIntervalSeconds</span>=<span class="hljs-string">&quot;120&quot;</span></span><br><span class="hljs-tag">           <span class="hljs-attr">memoryStoreEvictionPolicy</span>=<span class="hljs-string">&quot;LFU&quot;</span> /&gt;</span><br><br><span class="hljs-tag">&lt;/<span class="hljs-name">ehcache</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>构建ehcache的实例</p>
<p>name:缓存名称。<br>maxElementsInMemory:缓存最大数目<br>maxElementsOnDisk：硬盘最大缓存个数。<br>eternal:对象是否永久有效，一但设置了，timeout将不起作用。<br>overflowToDisk:是否保存到磁盘，当系统当机时<br>timeToIdleSeconds:设置对象在失效前的允许闲置时间（单位：秒）。仅当eternal=false对象不是永久有效时使 用，可选属性，默认值是0，也就是可闲置时间无穷大。<br>timeToLiveSeconds:设置对象在失效前允许存活时间（单位：秒）。最大时间介于创建时间和失效时间之间。仅 当eternal=false对象不是永久有效时使用，默认是0.，也就是对象存活时间无穷大。<br>diskPersistent：是否缓存虚拟机重启期数据Whether the disk store persists between restarts<br>of the Virtual Machine. The default value is false.<br>diskSpoolBufferSizeMB：这个参数设置DiskStore（磁盘缓存）的缓存区大小。默认是30MB。每个Cache都应该 有自己的一个缓冲区。<br>diskExpiryThreadIntervalSeconds：磁盘失效线程运行时间间隔，默认是120秒。<br>memoryStoreEvictionPolicy：当达到maxElementsInMemory限制时，Ehcache将会根据指定的策略去清理内 存。默认策略是LRU（最近最少使用）。<br>你可以设置为FIFO（先进先出）或是LFU（较少使用）。<br>clearOnFlush：内存数量最大时是否清除。<br>memoryStoreEvictionPolicy:可选策略有：LRU（最近最少使用，默认策略）、FIFO（先进先出）、LFU（最少 访问次数）。<br>FIFO，first in first out，这个是大家最熟的，先进先出。<br>LFU， Less Frequently Used，就是上面例子中使用的策略，直白一点就是讲一直以来最少被使用的。如上面 所讲，缓存的元素有一个hit属性，hit值最小的将会被清出缓存。<br>LRU，Least Recently Used，最近最少使用的，缓存的元素有一个时间戳，当缓存容量满了，而又需要腾出地 方来缓存新的元素的时候，那么现有缓存元素中时间戳离当前时间最远的元素将被清出缓存。</p>
<p>3.在spring容器集成ehcache</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span> <span class="hljs-attr">xmlns:aop</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/aop&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:c</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/c&quot;</span> <span class="hljs-attr">xmlns:cache</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/cache&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:jee</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/jee&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:lang</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/lang&quot;</span> <span class="hljs-attr">xmlns:mvc</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/mvc&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xmlns:p</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/p&quot;</span> <span class="hljs-attr">xmlns:task</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/task&quot;</span></span><br><span class="hljs-tag">       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">            http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd</span></span><br><span class="hljs-string"><span class="hljs-tag">            http://www.springframework.org/schema/cache http://www.springframework.org/schema/cache/spring-cache.xsd&quot;</span>&gt;</span><br>    <span class="hljs-comment">&lt;!-- 开启spring缓存,添加spring注解支持 --&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">cache:annotation-driven</span> <span class="hljs-attr">cache-manager</span>=<span class="hljs-string">&quot;cacheManager&quot;</span> /&gt;</span><br><span class="hljs-comment">&lt;!--声明一个缓存管理器（EhCacheCacheManager） 这里的实现代码是通过传入EhCache的CacheManager实例实现的 --&gt;</span><br>    <span class="hljs-comment">&lt;!-- 指定 ehcache配置文件路径--&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;ehcacheManager&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.cache.ehcache.EhCacheManagerFactoryBean&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;configLocation&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;classpath:ehcache.xml&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;cacheManager&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.cache.ehcache.EhCacheCacheManager&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;cacheManager&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;ehcacheManager&quot;</span> /&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;transactionAware&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>4.添加集成spring配置</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">import</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;classpath*:spring-ehcache.xml&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure>

<p>5.编写测试代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EcacheService</span> </span>&#123;<br>    <span class="hljs-meta">@CachePut(value = &quot;baseCache&quot;, key = &quot;&#x27;getUserFromEcache&#x27; + #id&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;Integer, User&gt; <span class="hljs-title">getUserFromEcache</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span> </span>&#123;<br>        Map&lt;Integer, User&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        Date d = <span class="hljs-keyword">new</span> Date();<br>        User u = <span class="hljs-keyword">new</span> User();<br>        u.setId(<span class="hljs-number">1</span>);<br>        u.setName(<span class="hljs-string">&quot;毛&quot;</span>);<br>        u.setPassword(<span class="hljs-string">&quot;admin&quot;</span>);<br>        u.setLoginDate(d);<br>        map.put(<span class="hljs-number">1</span>, u);<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/ehcache&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EhcacheController</span> </span>&#123;<br>    <span class="hljs-meta">@Autowired</span><br>    EcacheService service;<br>    <span class="hljs-meta">@Autowired</span><br>    CacheManager cacheManager;<br><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-meta">@RequestMapping(&quot;/getEhcache&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">getEhcache</span><span class="hljs-params">(Boolean flag)</span> </span>&#123;<br>        Map&lt;Integer, User&gt; userFromEcache = service.getUserFromEcache(<span class="hljs-number">1</span>);<br>        System.out.println(userFromEcache.get(<span class="hljs-number">1</span>));<br>        Cache cache = cacheManager.getCache(<span class="hljs-string">&quot;baseCache&quot;</span>);<br>        System.out.println(cache);<br>        Cache.ValueWrapper e = cache.get(<span class="hljs-string">&quot;getUserFromEcache1&quot;</span>);<br>        <span class="hljs-comment">//User user = cache.get(&quot;getUserFromEcache1&quot;, User.class);</span><br>        <span class="hljs-comment">///System.out.println(user);</span><br>        System.out.println(e.get().toString());<br>        Map o = (Map) e.get();<br>        System.out.println(o.get(<span class="hljs-number">1</span>));<br>        <span class="hljs-keyword">return</span> (User) o.get(<span class="hljs-number">1</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>注解详解：</p>
<p>参考博客：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/wchxj/p/8119528.html">https://www.cnblogs.com/wchxj/p/8119528.html</a></p>
<p><em><strong>1.1 @Cacheable</strong></em><br>@Cacheable可以标记在一个方法上，也可以标记在一个类上。当标记在一个方法上时表示该方法是支持缓存的，当标记在一个类上时则表示该类所有的方法都是支持缓存的。对于一个支持缓存的方法，Spring会在其被调用后将其返回值缓存起来，以保证下次利用同样的参数来执行该方法时可以直接从缓存中获取结果，而不需要再次执行该方法。Spring在缓存方法的返回值时是以键值对进行缓存的，值就是方法的返回结果，至于键的话，Spring又支持两种策略，默认策略和自定义策略，这个稍后会进行说明。需要注意的是当一个支持缓存的方法在对象内部被调用时是不会触发缓存功能的。@Cacheable可以指定三个属性，value、key和condition。</p>
<p>1.1.1 value属性指定Cache名称<br>value属性是必须指定的，其表示当前方法的返回值是会被缓存在哪个Cache上的，对应Cache的名称。其可以是一个Cache也可以是多个Cache，当需要指定多个Cache时其是一个数组。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Cacheable(&quot;cache1&quot;)</span><span class="hljs-comment">//Cache是发生在cache1上的</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">find</span><span class="hljs-params">(Integer id)</span> </span>&#123;<br>   <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>&#125;<br> <br><span class="hljs-meta">@Cacheable(&#123;&quot;cache1&quot;, &quot;cache2&quot;&#125;)</span><span class="hljs-comment">//Cache是发生在cache1和cache2上的</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">find</span><span class="hljs-params">(Integer id)</span> </span>&#123;<br>   <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>1.1.2 使用key属性自定义key<br>key属性是用来指定Spring缓存方法的返回结果时对应的key的。该属性支持SpringEL表达式。当我们没有指定该属性时，Spring将使用默认策略生成key。我们这里先来看看自定义策略，至于默认策略会在后文单独介绍。<br>自定义策略是指我们可以通过Spring的EL表达式来指定我们的key。这里的EL表达式可以使用方法参数及它们对应的属性。使用方法参数时我们可以直接使用“#参数名”或者“#p参数index”。下面是几个使用参数作为key的示例。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">EcacheService</span> </span>&#123;<br>    <span class="hljs-meta">@CachePut(value = &quot;baseCache&quot;, key = &quot;&#x27;getUserFromEcache&#x27; + #id&quot;)</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> Map&lt;Integer, User&gt; <span class="hljs-title">getUserFromEcache</span><span class="hljs-params">(<span class="hljs-keyword">int</span> id)</span> </span>&#123;<br>        Map&lt;Integer, User&gt; map = <span class="hljs-keyword">new</span> HashMap&lt;&gt;();<br>        Date d = <span class="hljs-keyword">new</span> Date();<br>        User u = <span class="hljs-keyword">new</span> User();<br>        u.setId(<span class="hljs-number">1</span>);<br>        u.setName(<span class="hljs-string">&quot;毛&quot;</span>);<br>        u.setPassword(<span class="hljs-string">&quot;admin&quot;</span>);<br>        u.setLoginDate(d);<br>        map.put(<span class="hljs-number">1</span>, u);<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>除了上述使用方法参数作为key之外，Spring还为我们提供了一个root对象可以用来生成key。通过该root对象我们可以获取到以下信息。</p>
<p><img src="/2021/12/05/Ehcache%E7%9A%84%E4%BD%BF%E7%94%A8/2451842-d8a0bfc7f2edf391.png" alt="img"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Cacheable(value=&#123;&quot;users&quot;, &quot;xxx&quot;&#125;, key=&quot;caches[1].name&quot;)</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">find</span><span class="hljs-params">(User user)</span> </span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>  &#125;<br></code></pre></td></tr></table></figure>

<p>1.1.3 condition属性指定发生的条件<br>有的时候我们可能并不希望缓存一个方法所有的返回结果。通过condition属性可以实现这一功能。condition属性默认为空，表示将缓存所有的调用情形。其值是通过SpringEL表达式来指定的，当为true时表示进行缓存处理；当为false时表示不进行缓存处理，即每次调用该方法时该方法都会执行一次。如下示例表示只有当user的id为偶数时才会进行缓存。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Cacheable(value=&#123;&quot;users&quot;&#125;, key=&quot;#user.id&quot;, condition=&quot;#user.id%2==0&quot;)</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">find</span><span class="hljs-params">(User user)</span> </span>&#123;<br>     System.out.println(<span class="hljs-string">&quot;find user by user &quot;</span> + user);<br>     <span class="hljs-keyword">return</span> user;<br>  &#125;<br></code></pre></td></tr></table></figure>

<p><em><strong>1.2 @CachePut</strong></em><br>在支持Spring Cache的环境下，对于使用@Cacheable标注的方法，Spring在每次执行前都会检查Cache中是否存在相同key的缓存元素，如果存在就不再执行该方法，而是直接从缓存中获取结果进行返回，否则才会执行并将返回结果存入指定的缓存中。<br>@CachePut也可以声明一个方法支持缓存功能。与@Cacheable不同的是使用@CachePut标注的方法在执行前不会去检查缓存中是否存在之前执行过的结果，而是每次都会执行该方法，并将执行结果（返回值）以键值对的形式存入指定的缓存中。所以必须有返回值，没有返回值则不会放入新的缓存。<br>@CachePut也可以标注在类上和方法上。使用@CachePut时我们可以指定的属性跟@Cacheable是一样的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@CachePut(&quot;users&quot;)</span><span class="hljs-comment">//每次都会执行方法，并将结果存入指定的缓存中</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">find</span><span class="hljs-params">(Integer id)</span> </span>&#123;<br>     <span class="hljs-keyword">return</span> user;<br>  &#125;<br></code></pre></td></tr></table></figure>

<p><em><strong>1.3 @CacheEvict</strong></em><br>@CacheEvict是用来标注在需要清除缓存元素的方法或类上的。当标记在一个类上时表示其中所有的方法的执行都会触发缓存的清除操作。@CacheEvict可以指定的属性有value、key、condition、allEntries和beforeInvocation。其中value、key和condition的语义与@Cacheable对应的属性类似。即value表示清除操作是发生在哪些Cache上的（对应Cache的名称）；key表示需要清除的是哪个key，如未指定则会使用默认策略生成的key；condition表示清除操作发生的条件。下面我们来介绍一下新出现的两个属性allEntries和beforeInvocation。<br>1.3.1 allEntries属性<br>allEntries是boolean类型，表示是否需要清除缓存中的所有元素。默认为false，表示不需要。当指定了allEntries为true时，Spring Cache将忽略指定的key。有的时候我们需要Cache一下清除所有的元素，这比一个一个清除元素更有效率。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@CacheEvict(value=&quot;users&quot;, allEntries=true)</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">delete</span><span class="hljs-params">(Integer id)</span> </span>&#123;<br>     System.out.println(<span class="hljs-string">&quot;delete user by id: &quot;</span> + id);<br>  &#125;<br></code></pre></td></tr></table></figure>

<p>1.3.2 beforeInvocation属性<br>清除操作默认是在对应方法成功执行之后触发的，即方法如果因为抛出异常而未能成功返回时也不会触发清除操作。使用beforeInvocation可以改变触发清除操作的时间，当我们指定该属性值为true时，Spring会在调用该方法之前清除缓存中的指定元素。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@CacheEvict(value=&quot;users&quot;, beforeInvocation=true)</span><br>  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">delete</span><span class="hljs-params">(Integer id)</span> </span>&#123;<br>     System.out.println(<span class="hljs-string">&quot;delete user by id: &quot;</span> + id);<br>  &#125;<br></code></pre></td></tr></table></figure>

<p>其实除了使用@CacheEvict清除缓存元素外，当我们使用Ehcache作为实现时，我们也可以配置Ehcache自身的驱除策略，其是通过Ehcache的配置文件来指定的。</p>
<p><em><strong>1.4 @Caching</strong></em><br>@Caching注解可以让我们在一个方法或者类上同时指定多个Spring Cache相关的注解。其拥有三个属性：cacheable、put和evict，分别用于指定@Cacheable、@CachePut和@CacheEvict。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Caching(cacheable = @Cacheable(&quot;users&quot;), evict = &#123; @CacheEvict(&quot;cache2&quot;),</span><br><span class="hljs-meta">      @CacheEvict(value = &quot;cache3&quot;, allEntries = **true**) &#125;)</span><br><span class="hljs-function"><span class="hljs-keyword">public</span> User <span class="hljs-title">find</span><span class="hljs-params">(Integer id)</span> </span>&#123;<br>   <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Key的默认策略<br>默认的key生成策略是通过KeyGenerator生成的，其默认策略如下：</p>
<ul>
<li>如果方法没有参数，则使用0作为key。</li>
<li>如果只有一个参数的话则使用该参数作为key。</li>
<li>如果参数多余一个的话则使用所有参数的hashCode作为key。</li>
</ul>
<p>如果我们需要指定自己的默认策略的话，那么我们可以实现自己的KeyGenerator，然后指定我们的Spring Cache使用的KeyGenerator为我们自己定义的KeyGenerator。<br>使用基于注解的配置时是通过cache:annotation-driven指定的.</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">cache:annotation-driven</span> <span class="hljs-attr">key-generator</span>=<span class="hljs-string">&quot;userKeyGenerator&quot;</span>/&gt;</span><br>  <br><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;userKeyGenerator&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.xxx.cache.UserKeyGenerator&quot;</span>/&gt;</span><br></code></pre></td></tr></table></figure>

<p>而使用基于XML配置时是通过cache:advice来指定的。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">cache:advice</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;cacheAdvice&quot;</span> <span class="hljs-attr">cache-manager</span>=<span class="hljs-string">&quot;cacheManager&quot;</span> <span class="hljs-attr">key-generator</span>=<span class="hljs-string">&quot;userKeyGenerator&quot;</span>&gt;</span><br>   <span class="hljs-tag">&lt;/<span class="hljs-name">cache:advice</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>小结：</p>
<p>其实EhCache使用的就是Spring Cache的注解，需要注意的是当一个支持缓存的方法在对象内部被调用时是不会触发缓存功能的。<br>@Cacheable参数：value指被缓存在哪个Cache上，key指缓存方法的返回结果对应的key，condition指什么情况下缓存。<br>@Cacheable如果在缓存中发现相同的key则会从缓存中取数据。@CachePut每次都会重新执行，然后将结果放入缓存。@CacheEvict表示清除缓存。<br>如果没有指定key。这是用Key的默认策略是（使用参数），也可以自定义key的生成策略。</p>
<div id="paginator"></div></div><p><strong>本文标题</strong>：Ehcache的使用<br><strong>本文作者</strong>：MaoZH<br><strong>本文链接</strong>：<a href="/2021/12/05/Ehcache%E7%9A%84%E4%BD%BF%E7%94%A8/">https://jack-edward.github.io/2021/12/05/Ehcache%E7%9A%84%E4%BD%BF%E7%94%A8/</a><br><strong>版权声明</strong>：转载或借鉴请注明出处，保留以上声明信息！</p><div class="post_share"><div class="social-share share-component" data-image="https://cdn.jsdelivr.net/gh/hassanblog/CDN/img/cover_character_drawing.png" data-sites="facebook,twitter,wechat,weibo,qq,qzone,tencent,douban,diandian,google,linkedin"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="all" onload="this.media=&quot;all&quot;"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer=""></script></div><div id="post-footer"><hr><a href="/2021/12/25/%E6%AF%8F%E6%97%A5%E4%B8%80%E9%A2%98/">← Prev 每日一题</a><span style="color: #fe2"> | </span><a href="/2021/11/21/spring%E9%9B%86%E6%88%90mybatis/">spring集成mybatis Next →</a><hr></div><div id="bottom-btn"><a id="to-index" href="#post-index" title="index">≡</a><a id="to-top" href="#post-title" title="to top">∧</a></div><div id="Valine"></div><script>new Valine({
 el: '#Valine'
 , appId: 'TWFe26C7GQDWyvw3lVpQUswj-gzGzoHsz'
 , appKey: 'kA8WG8bPJQ16UwOnhf7TGdHn'
 , placeholder: '欢迎大家评论，感谢批评指正'
})</script></div></article><aside><form><div class="tipue_search_group"><input id="tipue_search_input" type="text" name="q" placeholder="Search Here" pattern=".{3,}" title="At least 3 characters" autofocus="autofocus" required=""><button class="tipue_search_button" type="submit"><div class="tipue_search_icon">⚲</div></button></div></form><div id="tipue_search_content"></div><script>$(document).ready(function() {
$('#tipue_search_input').tipuesearch();
});</script><div id="about"><a href="/" id="logo"><img src="https://ak.hypergryph.com/assets/index/images/ak/pc/faction/1.png" alt="Logo"></a><div id="he-plugin-standard"></div><script>WIDGET = {
"CONFIG": {
"layout": "1",
"width": 450,
"height": 150,
"background": "3",
"dataColor": "FFFFFF",
"key": "e2043117ad6d459bb0eb89b26de1b4a2"
}
}</script><script src="https://widget.qweather.net/standard/static/js/he-standard-common.js?v=2.0"></script><h1 id="dr"><a href="/"> Mr.MaoZH</a></h1><section id="total"><a id="total-archives" href="/archives"><span class="total-title">Archives Total:</span><span class="total-number">9</span></a><div id="total-tags"><span class="total-title">Tags:</span><span class="total-number">10</span></div><div id="total-categories"><span class="total-title">Categories:</span><span class="total-number">4</span></div></section></div><div id="about-me"><span class="about-me">Contact-me:</span><a href="tencent://message/?uin=3128633651&amp;amp;site=qq&amp;amp;menu=yes"><img src="https://im.qq.com/favicon.ico"></a><a href="mailto:3128633651@qq.com"><img src="https://cdn.jsdelivr.net/gh/honjun/cdn@1.6/img/social/email.svg" width="20"></a></div><div id="aside-block"><div id="aside"><h1>INDEX</h1><div id="post-index"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Ehcache%E7%9A%84%E4%BD%BF%E7%94%A8"><span class="toc-number">1.</span> <span class="toc-text">Ehcache的使用</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-%E5%9F%BA%E6%9C%AC%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.1.</span> <span class="toc-text">1. 基本介绍</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-%E4%B8%BB%E8%A6%81%E7%9A%84%E7%89%B9%E6%80%A7%E6%9C%89%EF%BC%9A"><span class="toc-number">1.2.</span> <span class="toc-text">2. 主要的特性有：</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3-ehcache-%E5%92%8C-redis-%E6%AF%94%E8%BE%83"><span class="toc-number">1.3.</span> <span class="toc-text">3. ehcache 和 redis 比较</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#4-spring%E9%9B%86%E6%88%90ehcache"><span class="toc-number">1.4.</span> <span class="toc-text">4.spring集成ehcache</span></a></li></ol></li></ol></div><div id="post-index"></div></div></div><footer><nobr><span class="text-title">©</span><span class="text-content">2020 to 2021</span></nobr><wbr><nobr><span class="text-title">ICP</span><span class="text-content">——备案号——</span></nobr><wbr><wbr><nobr>published with&nbsp;<a href="https://jack-edward.github.io">Zhihui Mao&nbsp;</a></nobr><wbr><nobr>Theme&nbsp;<a href="">Arknight&nbsp;</a></nobr><wbr><nobr>by&nbsp;<a href="">Yue_plus </a></nobr><wbr><script type="text/javascript" src="jquery.min.js"></script><script type="text/javascript">$(document).ready(function(){
//通过调用新浪IP地址库接口查询用户当前所在国家、省份、城市、运营商信息
$.getScript('https://pv.sohu.com/cityjson?ie=utf-8',function(){
$(".city").html(returnCitySN.cname);
$(".ip").html(returnCitySN.cip);
//$(".browser").html(navigator.appVersion);
});
});</script></footer><div>欢迎来自<span class="city"></span>地区的朋友<br>您的IP地址为：<span class="ip"></span><!--| <br>您的浏览器为：--><!--span.browser--><wbr><script type="text/javascript" src="//rf.revolvermaps.com/0/0/1.js?i=52al2pyccg1&amp;s=216&amp;m=0&amp;v=true&amp;r=false&amp;b=000000&amp;n=false&amp;c=ff0000" async="async"></script><wbr><iframe frameborder="no" border="0" marginwidth="0" marginheight="0" width=330 height=86 src="//music.163.com/outchain/player?type=2&id=406086764&auto=0&height=66"></iframe></div></aside></main><canvas id="canvas-dust"></canvas><script src="/js/arknights.js"></script><script src="https://cdn.bootcdn.net/ajax/libs/highlight.js/10.1.2/highlight.min.js"></script></body></html>